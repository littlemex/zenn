---
title: "vllm-neuron ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœ"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["vllm", "AWSNeuron", "Profiler", "Python", "æ€§èƒ½æœ€é©åŒ–"]
published: false
---

## ã¯ã˜ã‚ã«

[å‰å›ã®è¨˜äº‹](https://zenn.dev/tosshi/articles/d68bd091d1934d) ã§ã¯ãƒ„ãƒ¼ãƒ«ã‚’ä½œã‚‹ã®ã«å¤¢ä¸­ã«ãªã£ã¦ã—ã¾ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã¾ã§å®Ÿæ–½ã§ããªã‹ã£ãŸãŸã‚ã€ä»Šå›ã®è¨˜äº‹ã§ã¯å‰å›ã®çµæœã‚’ã‚‚ã¨ã« AWS Neuron Profiler ã‚’ç”¨ã„ã¦ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã‚’å®Ÿæ–½ã—ã¦ã¿ã‚‹ã“ã¨ã§ã€ä½•ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã£ã¦ã„ã‚‹ã®ã‹ã®ç‰¹å®šã‚’è©¦ã¿ã¾ã™ã€‚å‰å›ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãƒ»ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã¨ã‚‚ã«ãƒ™ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã ã£ãŸè¨­å®šã‚’å‡ºç™ºç‚¹ã¨ã—ã¦ã€ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚»ã‚¹ã§æ€§èƒ½ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

ã¾ãš AWS Neuron Profiler ã«ã‚ˆã‚‹ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã§ç¾çŠ¶ã‚’æŠŠæ¡ã—ã¦ã¿ã¾ã™ã€‚

:::message alert
é€šå¸¸ã€å˜ã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã ã‘ã§ã¯çœŸã®æ€§èƒ½ã¯å¼•ãå‡ºã›ã¾ã›ã‚“ã€‚é©åˆ‡ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®ç‰¹å®šãƒ»è§£æ¶ˆãŒä¸å¯æ¬ ã§ã™ã€‚GPU ã‚„ AWS Trainium ãªã©ã§ã¯ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãªã©ã§ã®æ§‹æˆãŒç•°ãªã‚Šã¾ã™ã€‚ãã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚„ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€è¨­å®šã®å½±éŸ¿ã‚‚ã‚ã‚Šã¾ã™ã€‚æ€§èƒ½ã®è‰¯ã•ã‚’å›³ã‚‹æŒ‡æ¨™ã¯ä¸€ã¤ã§ã¯ãªãã€ã‚³ã‚¹ãƒˆã‚„ç²¾åº¦ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã«ã—ã¦ã‚‚å¹³å‡å€¤ãªã®ã‹ P99 ã§ã®è‰¯ã•ãªã®ã‹ã€æ§˜ã€…ãªè¦–ç‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«ã¨ã£ã¦ã®æ€§èƒ½ã®è‰¯ã•ã‚’å®šç¾©ã™ã¹ãã§ã—ã‚‡ã†ã€‚
:::

## Phase 1: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°

### 1.1 ãªãœãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã‹ã‚‰å§‹ã‚ã‚‹ã®ã‹

æ€§èƒ½æœ€é©åŒ–ã‚’è¡Œã†éš›ã€ã¾ãšç¾çŠ¶ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¸¬å®šã§ã¯æ€§èƒ½ã®çµæœã¯åˆ†ã‹ã‚Šã¾ã™ãŒã€æ€§èƒ½ã®ç†ç”±ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®å ´æ‰€ã€ãã—ã¦æ”¹å–„ã®ä½™åœ°ã¯åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚ãã“ã§æœ€åˆã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã§ã€NeuronCore ã®ä½¿ç”¨ç‡ï¼ˆã©ã‚Œã ã‘æ¼”ç®—ã—ã¦ã„ã‚‹ã‹ï¼‰ã€ãƒ¡ãƒ¢ãƒªå¸¯åŸŸã®ä½¿ç”¨çŠ¶æ³ï¼ˆãƒ‡ãƒ¼ã‚¿è»¢é€ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¯ï¼Ÿï¼‰ã€æ¼”ç®—åŠ¹ç‡ï¼ˆæ¼”ç®—ãƒ¦ãƒ‹ãƒƒãƒˆãŒéŠã‚“ã§ã„ãªã„ã‹ï¼Ÿï¼‰ã¨ã„ã£ãŸè©³ç´°ãªæƒ…å ±ã‚’å¾—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæœ€é©åŒ–æˆ¦ç•¥ã‚’ç«‹ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

AWS ã®ãƒ–ãƒ­ã‚°è¨˜äº‹[ã€ŒUnlocking Machine Learning Model Performanceã€](https://builder.aws.com/content/2x3ldAuia9gjjUixpOt162ttkK2/unlocking-machine-learning-model-performance-from-bottlenecks-to-breakthroughs) ã¯ AWS Neuron Profiler ã®ç†è§£ã«ã¨ã¦ã‚‚æœ‰ç”¨ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ AWS Neuron Profiler 2.0 ã®æ´»ç”¨æ–¹æ³•ã¨ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‹ã‚‰æ€§èƒ½å‘ä¸Šã¾ã§ã®é“ç­‹ãŒè©³ã—ãè§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚

:::message
æ€§èƒ½æœ€é©åŒ–ã«ãŠã„ã¦é‡è¦ãªã®ã¯ã€æ˜ç¢ºãªç›®æ¨™ã¨åˆ¶ç´„æ¡ä»¶ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã™ã€‚ã€Œãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã‚’æ”¹å–„ã—ãŸã„ã€ã¨ã„ã†æ¼ ç„¶ã¨ã—ãŸç›®æ¨™ã ã‘ã§ã¯ã€æœ€é©åŒ–ã®å•é¡Œç©ºé–“ãŒå®šç¾©ã§ãã¾ã›ã‚“ã€‚ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ï¼ˆP50/P95/P99ï¼‰ã€ã‚³ã‚¹ãƒˆã€ç²¾åº¦ãªã©ã€è¤‡æ•°ã®æŒ‡æ¨™ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’è€ƒæ…®ã—ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¿œã˜ãŸæ€§èƒ½ã®è‰¯ã•ã‚’æ˜ç¢ºã«ã™ã‚‹ã“ã¨ãŒã€åŠ¹æœçš„ãªæœ€é©åŒ–ã¸ã®ç¬¬ä¸€æ­©ã§ã™ã€‚ä»Šå›ã¯ç°¡å˜ã®ãŸã‚ã« å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼æœ€é©åŒ–ã€ã¨ã—ã¦ãŠãã¾ã™ã€‚**ä»Šå›ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã®é€²ã‚æ–¹ã¯çµæœçš„ã«é–“é•ã£ã¦ã„ãŸã¨æ€ã‚ã‚Œã‚‹ã®ã§ãã®éç¨‹ã‚‚å«ã‚ã¦èª­ã‚“ã§ã‚‚ã‚‰ãˆã‚Œã°ã¨æ€ã„ã¾ã™ã€‚**
:::

### 1.2 ç¾çŠ¶æœ€é©è¨­å®šã§ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœã®ç¢ºèª

Perfetto ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦æ‰±ãˆã¾ã™ã€‚Perfetto ã®[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://perfetto.dev/docs/analysis/trace-processor-python) ã«ã‚ˆã‚‹ã¨ã€TraceProcessor ã‚’ä½¿ã£ã¦ SQL ã‚¯ã‚¨ãƒªã§åˆ†æã§ãã¾ã™ã€‚

```python
from perfetto.trace_processor import TraceProcessor
tp = TraceProcessor(trace='profile_output/trace.perfetto-trace')

qr_it = tp.query('SELECT ts, dur, name, track_id FROM slice LIMIT 10')
qr_df = qr_it.as_pandas_dataframe()
print(qr_df.to_string())
```

ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚Perfetto ãƒˆãƒ¬ãƒ¼ã‚¹ã«ã¯ slice ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Šã€å„æ“ä½œï¼ˆé–¢æ•°å‘¼ã³å‡ºã—ã€ã‚«ãƒ¼ãƒãƒ«å®Ÿè¡Œãªã©ï¼‰ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚

```
    ts   dur             name track_id
0    5    21              NOP        0
1    7     7            DRAIN        1
2   53     8            DRAIN        2
3   56    23            DRAIN        3
4   57    59            WRITE        4
5   64  5494  EVENT_SEMAPHORE        1
6   84   120              NOP        0
7  125  5491  EVENT_SEMAPHORE        2
8  141  5447  EVENT_SEMAPHORE        3
9  401   194            WRITE        0
```

ä¸»è¦ãªã‚«ãƒ©ãƒ ã¨ã—ã¦ã€tsï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ãƒŠãƒç§’å˜ä½ï¼‰ã€durï¼ˆç¶™ç¶šæ™‚é–“ã€ãƒŠãƒç§’å˜ä½ï¼‰ã€nameï¼ˆæ“ä½œåã€ä¾‹ãˆã° MATMUL ã‚„ DMA_DIRECT2Dï¼‰ã€track_idï¼ˆãƒˆãƒ©ãƒƒã‚¯ IDã€ã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰/ãƒ—ãƒ­ã‚»ã‚¹ã‹ï¼‰ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä»–ã«ã‚‚ã‚¯ã‚¨ãƒªã‚’ã„ãã¤ã‹å®Ÿè¡Œã—ã¦æƒ…å ±ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚ã¾ãšãƒˆãƒ¬ãƒ¼ã‚¹å…¨ä½“ã®æ™‚é–“ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—ã—ã¾ã™ã€‚

::::details ãƒˆãƒ¬ãƒ¼ã‚¹æ™‚é–“

```python
from perfetto.trace_processor import TraceProcessor
tp = TraceProcessor(trace='profile_output/trace.perfetto-trace')

sql = """
SELECT
    MAX(ts) / 1e9 AS duration_seconds,
    COUNT(*) AS total_slices
FROM slice
"""

qr_it = tp.query(sql)
qr_df = qr_it.as_pandas_dataframe()
print(qr_df.to_string())
```

ã“ã®çµæœã‹ã‚‰ã€ãƒˆãƒ¬ãƒ¼ã‚¹æ™‚é–“ãŒ 0.016 ç§’ï¼ˆç´„ 16 ãƒŸãƒªç§’ï¼‰ã§ã‚ã‚Šã€ç·ã‚¹ãƒ©ã‚¤ã‚¹æ•°ãŒ 350,522 ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```
  duration_seconds total_slices
0         0.015755       350522
```

::::

::::details Operation ã”ã¨ã®é›†è¨ˆ

ã©ã® Operation ãŒä½•å›å®Ÿè¡Œã•ã‚ŒãŸã‹ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚ä»¥é™ã€SQL ã®éƒ¨åˆ†ã ã‘ç¤ºã—ã¾ã™ã€‚

```sql
SELECT
    name,                              -- æ“ä½œå
    COUNT(*) as count,                 -- å®Ÿè¡Œå›æ•°
    SUM(dur) / 1e9 as total_seconds,   -- åˆè¨ˆæ™‚é–“ï¼ˆç§’ï¼‰
    AVG(dur) / 1e9 as avg_seconds,     -- å¹³å‡æ™‚é–“ï¼ˆç§’ï¼‰
    MAX(dur) / 1e9 as max_seconds      -- æœ€å¤§æ™‚é–“ï¼ˆç§’ï¼‰
FROM slice
WHERE dur > 0                          -- æ™‚é–“ãŒ0ã‚ˆã‚Šå¤§ãã„ã‚‚ã®
GROUP BY name                          -- æ“ä½œåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
ORDER BY total_seconds DESC            -- åˆè¨ˆæ™‚é–“ã®é™é †
LIMIT 10
```

```
                    name   count total_seconds avg_seconds max_seconds
0                unknown  156427      0.038387         0.0    0.000003
1                 MATMUL   21582      0.010941    0.000001    0.000002
2  custom_call.17_sg0002      36      0.007028    0.000195    0.007017
3              LDWEIGHTS   21212      0.004914         0.0    0.000001
4        EVENT_SEMAPHORE    2184      0.003879    0.000002    0.000057
5            FIND_INDEX8     224      0.002261     0.00001    0.000014
6                   MAX8     224      0.002261     0.00001    0.000014
7         MATCH_REPLACE8     217      0.002187     0.00001    0.000014
8                           1276       0.00173    0.000001    0.000026
9               ACTIVATE    4702      0.001648         0.0    0.000001
```

ã“ã®çµæœã‹ã‚‰èˆˆå‘³æ·±ã„æƒ…å ±ãŒè¦‹ã¦å–ã‚Œã¾ã™ã€‚ã¾ãš unknown ã¨ã„ã†æ“ä½œãŒ 38 ãƒŸãƒªç§’ã‹ã‹ã£ã¦ãŠã‚Šã€156,427 å›ã¨æœ€ã‚‚é »ç¹ã«å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚ŒãŒä½•ã®æ“ä½œã‹ä¸æ˜ãªã®ã¯æ°—ã«ãªã‚‹ã¨ã“ã‚ã§ã™ã€‚æ¬¡ã« MATMULï¼ˆè¡Œåˆ—ä¹—ç®—ï¼‰ãŒ 11 ãƒŸãƒªç§’ã€21,582 å›å®Ÿè¡Œã•ã‚Œã¦ãŠã‚Šã€ã“ã‚ŒãŒå®Ÿéš›ã®è¨ˆç®—ã®ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚å¹³å‡ 0.5 ãƒã‚¤ã‚¯ãƒ­ç§’ã€æœ€å¤§ 2 ãƒã‚¤ã‚¯ãƒ­ç§’ã¨ã„ã†é€Ÿåº¦ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚

ç‰¹ã«æ³¨ç›®ã™ã¹ãã¯ custom_call.17_sg0002 ã¨ã„ã†æ“ä½œã§ã™ã€‚ãŸã£ãŸ 36 å›ã®å®Ÿè¡Œã§ 7 ãƒŸãƒªç§’ã‚‚æ¶ˆè²»ã—ã¦ãŠã‚Šã€å¹³å‡ 195 ãƒã‚¤ã‚¯ãƒ­ç§’ã€æœ€å¤§ 7,017 ãƒã‚¤ã‚¯ãƒ­ç§’ï¼ˆç´„ 7 ãƒŸãƒªç§’ï¼‰ã¨ãªã£ã¦ã„ã¾ã™ã€‚æœ€å¤§ãŒå¹³å‡ã®ç´„ 36 å€ã¨ãªã£ã¦ã„ã¾ã™ã€‚

ã¾ãŸ LDWEIGHTSï¼ˆé‡ã¿ã®ãƒ­ãƒ¼ãƒ‰æ“ä½œï¼‰ãŒ 5 ãƒŸãƒªç§’ã‹ã‹ã£ã¦ãŠã‚Šã€21,212 å›ã¨ MATMUL ã¨ã»ã¼åŒã˜å›æ•°å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯æ¯å›é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã‚’ç¤ºå”†ã—ã¦ãŠã‚Šã€é‡ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã«ã‚ˆã‚‹æœ€é©åŒ–ã®ä½™åœ°ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

EVENT_SEMAPHORE ã¯ã‚³ã‚¢é–“ã®åŒæœŸã« 4 ãƒŸãƒªç§’ã‹ã‹ã£ã¦ãŠã‚Šã€2,184 å›å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚æœ€å¤§ 57 ãƒã‚¤ã‚¯ãƒ­ç§’ã¨ã„ã†å€¤ã‹ã‚‰ã€æ™‚ã€…å¾…ãŸã•ã‚Œã¦ã„ã‚‹çŠ¶æ³ãŒè¦‹ãˆã¾ã™ã€‚

::::

### 1.3 custom_call ã®è©³ç´°åˆ†æ

custom_call.17_sg0002 ã¨ã„ã†æ“ä½œãŒãŸã£ãŸ 36 å›ã®å®Ÿè¡Œã§ 7 ãƒŸãƒªç§’ã‚‚æ¶ˆè²»ã—ã¦ã„ã‚‹ã“ã¨ãŒæ°—ã«ãªã‚Šã¾ã™ã€‚ã“ã‚ŒãŒä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã€ã‚ˆã‚Šè©³ã—ãèª¿ã¹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```sql
SELECT
    name,                          -- æ“ä½œå
    ts / 1e6 as start_ms,          -- é–‹å§‹æ™‚åˆ»ï¼ˆãƒŸãƒªç§’ï¼‰
    dur / 1e6 as dur_ms,           -- ç¶™ç¶šæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    track_id                       -- ãƒˆãƒ©ãƒƒã‚¯ID
FROM slice
WHERE name LIKE 'custom_call%'    -- custom_call ã§å§‹ã¾ã‚‹æ“ä½œ
ORDER BY ts                        -- æ™‚ç³»åˆ—é †
LIMIT 20                           -- æœ€åˆã®20ä»¶
```

::::details çµæœ
```
                 name  start_ms    dur_ms track_id
0   custom_call.15_sg0002  8.690942  0.000289       75
1   custom_call.15_sg0002  8.690942  0.071542      437
2   custom_call.17_sg0002  8.693388  0.000289       75
3   custom_call.17_sg0002  8.693388  7.016822      438
4   custom_call.15_sg0002  8.698995  0.000289       69
5   custom_call.17_sg0002  8.702275  0.000289       69
6   custom_call.15_sg0002  8.709122  0.000289       76
7   custom_call.15_sg0002  8.711823  0.000289       79
8   custom_call.17_sg0002  8.711922  0.000289       76
9   custom_call.17_sg0002  8.713703  0.000289       79
10  custom_call.15_sg0002   8.72291  0.001519       80
11  custom_call.15_sg0002  8.725887  0.003295       78
12  custom_call.17_sg0002  8.726715  0.000044       80
13  custom_call.15_sg0002  8.729073  0.000285       66
14  custom_call.17_sg0002  8.729077  0.004764      106
15  custom_call.15_sg0002  8.729329  0.004596        6
16  custom_call.17_sg0002  8.730493  0.000289       66
17  custom_call.17_sg0002  8.733815  0.002756        7
18  custom_call.15_sg0002  8.736056  0.000289       77
19  custom_call.17_sg0002  8.738496  0.000289       77
```
::::

é‡è¦ãªç™ºè¦‹ã¨ã—ã¦ã€3 è¡Œç›®ã® custom_call.17_sg0002 ãŒ 7.017 ãƒŸãƒªç§’ã‹ã‹ã£ã¦ã„ã‚‹ï¼ˆtrack_id: 438ï¼‰ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ã»ã¨ã‚“ã©ã® custom_call ã¯ 0.3 ãƒã‚¤ã‚¯ãƒ­ç§’ç¨‹åº¦ãªã®ã«ã€ã“ã® 1 å›ã ã‘ç•°å¸¸ã«é…ã„ã§ã™ã€‚ã“ã‚Œã¯åˆå›å®Ÿè¡Œã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«/æœ€é©åŒ–ã‚³ã‚¹ãƒˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

æ¬¡ã«ã€ã™ã¹ã¦ã® custom_call ã®çµ±è¨ˆã‚’ç¢ºèªã—ã¾ã™ã€‚

```sql
SELECT
    name,                              -- æ“ä½œå
    COUNT(*) as count,                 -- å®Ÿè¡Œå›æ•°
    MIN(dur) / 1e6 as min_ms,          -- æœ€å°æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    MAX(dur) / 1e6 as max_ms,          -- æœ€å¤§æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    AVG(dur) / 1e6 as avg_ms,          -- å¹³å‡æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    SUM(dur) / 1e6 as total_ms         -- åˆè¨ˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
FROM slice
WHERE name LIKE 'custom_call%'         -- custom_call ã§å§‹ã¾ã‚‹æ“ä½œ
GROUP BY name                          -- æ“ä½œåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
ORDER BY avg_ms DESC                   -- å¹³å‡æ™‚é–“ã®é™é †
```

::::details çµæœ
```
                   name count    min_ms    max_ms    avg_ms  total_ms
0  custom_call.17_sg0002    36  0.000007  7.016822  0.195235  7.028449
1  custom_call.15_sg0002    54  0.000007  0.071542  0.001588  0.085729
2  custom_call.16_sg0002    36  0.000007  0.001701  0.000067  0.002409
3  custom_call.14_sg0002    36  0.000007  0.000441  0.000031   0.00111
```
::::

ã“ã®çµæœã‹ã‚‰ã€custom_call.17_sg0002 ã¯å¹³å‡ 195 ãƒã‚¤ã‚¯ãƒ­ç§’ã§ã™ãŒã€æœ€å¤§ã¯ 7 ãƒŸãƒªç§’ï¼ˆ36 å€ã®å·®ï¼ï¼‰ã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚custom_call.15_sg0002 ã‚‚æœ€å¤§ 71.5 ãƒã‚¤ã‚¯ãƒ­ç§’ã§ãã“ãã“ã°ã‚‰ã¤ããŒã‚ã‚Šã¾ã™ãŒã€ä»–ã® custom_call ã¯æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã® custom_call ã¯ XLA ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¼ãƒ«å‘½ä»¤ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ï¼ˆ[AWS Neuron Custom C++ Operators ã‚„ NKI ã‚«ãƒ¼ãƒãƒ«ãªã©](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/neuron-customops/index.html)ï¼‰ã€‚ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€åˆå›å®Ÿè¡Œæ™‚ã« 7.017 ãƒŸãƒªç§’ãŒè¦³æ¸¬ã•ã‚Œã¦ãŠã‚Šã€ãã®å¾Œã®å®Ÿè¡Œã§ã¯ç´„ 0.3 ãƒã‚¤ã‚¯ãƒ­ç§’ã¨å¤§å¹…ã«é«˜é€ŸåŒ–ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯åˆå›å®Ÿè¡Œæ™‚ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚„æœ€é©åŒ–ã‚³ã‚¹ãƒˆã‚’ç¤ºå”†ã—ã¦ã„ãã†ã§ã™ã€‚vllm-neuron ã§ã¯ [`skip_warmup`](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/libraries/nxd-inference/vllm/quickstart-vllm-offline-serving.html) ã¨ã„ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ãƒ‘ã‚¹ã®å®Ÿè¡Œã‚’åˆ¶å¾¡ã§ãã€`skip_warmup=False` ã«è¨­å®šã™ã‚‹ã¨äº‹å‰ã«ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

### 1.4 MATMUL/LDWEIGHTS ã®ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ

æ¬¡ã«ã€æœ€ã‚‚æ™‚é–“ã‚’æ¶ˆè²»ã—ã¦ã„ã‚‹ MATMUL ã¨ LDWEIGHTS ã®é–¢ä¿‚æ€§ã‚’èª¿ã¹ã¦ã¿ã¾ã™ã€‚

```sql
SELECT
    name,                              -- æ“ä½œå
    COUNT(*) as count,                 -- å®Ÿè¡Œå›æ•°
    SUM(dur) / 1e6 as total_ms,        -- åˆè¨ˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    AVG(dur) / 1e6 as avg_ms           -- å¹³å‡æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
FROM slice
WHERE name IN ('MATMUL', 'LDWEIGHTS', 'ACTIVATE', 'COPY')  -- ä¸»è¦ãªæ¼”ç®—æ“ä½œ
GROUP BY name                          -- æ“ä½œåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
ORDER BY total_ms DESC                 -- åˆè¨ˆæ™‚é–“ã®é™é †
```

::::details çµæœ
```
     name count   total_ms    avg_ms
   MATMUL 21582  10.940548  0.000507
LDWEIGHTS 21212   4.913657  0.000232
 ACTIVATE  4702   1.648057  0.000351
     COPY    83    0.02587  0.000312
```
::::

èˆˆå‘³æ·±ã„ç™ºè¦‹ã¨ã—ã¦ã€MATMUL ãŒ 21,582 å›ã€LDWEIGHTS ãŒ 21,212 å›ã¨ã»ã¼åŒã˜å›æ•°å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ MATMUL ã®ãŸã³ã«é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã‚’ç¤ºå”†ã—ã¦ã„ã¾ã™ã€‚é‡ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ãŒåŠ¹ã„ã¦ã„ã‚Œã° LDWEIGHTS ã®å›æ•°ã¯ã‚‚ã£ã¨å°‘ãªã„ã¯ãšã§ã™ã€‚ã“ã‚Œã¯æœ€é©åŒ–ã®ä½™åœ°ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

MATMUL ã®æ™‚ç³»åˆ—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```sql
SELECT
    ts / 1e9 as time_sec,              -- æ™‚åˆ»ï¼ˆç§’ï¼‰
    dur / 1e6 as dur_ms                -- ç¶™ç¶šæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
FROM slice
WHERE name = 'MATMUL'                  -- MATMUL æ“ä½œã®ã¿
ORDER BY ts                            -- æ™‚ç³»åˆ—é †
LIMIT 100                              -- æœ€åˆã®100ä»¶
```

```python
df_matmul = tp.query(sql).as_pandas_dataframe()
print(df_matmul.describe())
```

::::details çµæœ
```
          time_sec      dur_ms
count   100.000000  100.000000
unique  100.000000   21.000000
top       0.001886    0.000199
freq      1.000000   23.000000
mean      0.002019    0.000196
std       0.000180    0.000007
min       0.001886    0.000185
25%       0.001890    0.000190
50%       0.001967    0.000196
75%       0.002090    0.000199
max       0.002587    0.000211
```
::::

MATMUL ã®ç‰¹å¾´ã¨ã—ã¦ã€å®Ÿè¡Œæ™‚é–“ã¯æ¯”è¼ƒçš„å®‰å®šï¼ˆæ¨™æº–åå·® 0.007 ãƒã‚¤ã‚¯ãƒ­ç§’ï¼‰ã—ã¦ãŠã‚Šã€å¹³å‡ 196 ãƒŠãƒç§’ã¨éå¸¸ã«é«˜é€Ÿã§ã™ã€‚ã¾ãŸ 21 ç¨®é¡ã®ç•°ãªã‚‹å®Ÿè¡Œæ™‚é–“ãŒè¦³æ¸¬ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã¯ç•°ãªã‚‹è¡Œåˆ—ã‚µã‚¤ã‚ºã‚’å‡¦ç†ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ã¦ã„ã¾ã™ã€‚

## Phase 2: skip_warmup è¨­å®šã®å½±éŸ¿èª¿æŸ»

### 2.1 ä»®èª¬: skip_warmup=False ã§æœ€é©åŒ–ã•ã‚Œã‚‹ã®ã§ã¯ï¼Ÿ

Phase 1 ã®åˆ†æã§ã€custom_call ãŒåˆå›å®Ÿè¡Œæ™‚ã«å¤§ããªé…å»¶ã‚’èµ·ã“ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚vllm-neuron ã«ã¯ skip_warmup ã¨ã„ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã€ã“ã‚Œã‚’ False ã«è¨­å®šã™ã‚‹ã¨ã€ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–æ™‚ã«äº‹å‰ã«ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

è¨­å®šå¤‰æ›´ã¨ã—ã¦ã€conftest.py ã«ãŠã„ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

```python
# conftest.py
"additional_config": {
    "override_neuron_config": {
        "skip_warmup": False,  # True â†’ False ã«å¤‰æ›´
        "pa_num_blocks": config['vllm']['num_gpu_blocks_override'],
        "pa_block_size": 32,
        "enable_bucketing": True,
    }
}
```

### 2.2 ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœã®æ¯”è¼ƒ

ã¾ãšã€ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ€§èƒ½ãŒã©ã†å¤‰åŒ–ã—ãŸã‹ç¢ºèªã—ã¾ã™ã€‚

| è¨­å®š | å¹³å‡æ™‚é–“ | æœ€å°æ™‚é–“ | æœ€å¤§æ™‚é–“ | å·®åˆ† |
|------|---------|---------|---------|------|
| Baseline (skip_warmup=True) | 2.992ç§’ | 2.987ç§’ | 3.002ç§’ | - |
| Warmup (skip_warmup=False) | 3.110ç§’ | 3.097ç§’ | 3.120ç§’ | +3.9% |

`skip_warmup=False` ã®æ–¹ãŒé…ã„ã¨ã„ã†çµæœãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã™ã‚Œã°é€Ÿããªã‚‹ã¨äºˆæƒ³ã—ã¦ã„ã¾ã—ãŸãŒã€å®Ÿéš›ã«ã¯ç´„ 4% é…ããªã‚Šã¾ã—ãŸã€‚ã«ã‚ƒãƒ¼ã‚“ã€‚

:::message alert
ã“ã®æ¸¬å®šçµæœã«ã¯ã€ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ™‚é–“ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
:::

### 2.3 ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¯”è¼ƒåˆ†æ

æ¬¡ã«ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœã‚’æ¯”è¼ƒã—ã¦ã€ãªãœé…ããªã£ãŸã®ã‹ã‚’èª¿ã¹ã¾ã™ã€‚ã¾ãšã€ç”Ÿæˆã•ã‚ŒãŸ NTFF ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•°ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
# Baseline (skip_warmup=True) # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒãƒ¼ãƒ ã—ã¾ã—ãŸã€‚
$ find profile_output_baseline -name "*.ntff" | wc -l
4

# Warmup (skip_warmup=False)
$ find profile_output -name "*.ntff" | wc -l
22
```

NTFF ãƒ•ã‚¡ã‚¤ãƒ«ãŒ 4 å€‹ã‹ã‚‰ 22 å€‹ã«å¢—åŠ ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ™‚ã«è¤‡æ•°ã®ç•°ãªã‚‹ã‚°ãƒ©ãƒ•ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

æ¬¡ã«ã€ãƒˆãƒ¬ãƒ¼ã‚¹å†…ã®æ“ä½œã‚’æ¯”è¼ƒã—ã¾ã™ã€‚

```python
from perfetto.trace_processor import TraceProcessor

# Baseline ãƒˆãƒ¬ãƒ¼ã‚¹
tp_baseline = TraceProcessor(trace='profile_output_baseline/trace.perfetto-trace')

# Warmup ãƒˆãƒ¬ãƒ¼ã‚¹
tp_warmup = TraceProcessor(trace='profile_output/trace_warmup.perfetto-trace')

sql = """
SELECT
    name,
    COUNT(*) as count,
    SUM(dur) / 1e6 as total_ms,
    AVG(dur) / 1e6 as avg_ms
FROM slice
WHERE name IN ('MATMUL', 'LDWEIGHTS', 'ACTIVATE', 'COPY')
GROUP BY name
ORDER BY total_ms DESC
"""

# Baseline ã®çµæœ
print("Baseline (skip_warmup=True):")
df_baseline = tp_baseline.query(sql).as_pandas_dataframe()
print(df_baseline.to_string(index=False))

# Warmup ã®çµæœ
print("\nWarmup (skip_warmup=False):")
df_warmup = tp_warmup.query(sql).as_pandas_dataframe()
print(df_warmup.to_string(index=False))
```

::::details çµæœ
```
Baseline (skip_warmup=True):
     name count   total_ms    avg_ms
   MATMUL 21582  10.940548  0.000507
LDWEIGHTS 21212   4.913657  0.000232
 ACTIVATE  4702   1.648057  0.000351
     COPY    83    0.02587  0.000312

Warmup (skip_warmup=False):
     name count  total_ms    avg_ms
 ACTIVATE  4207  2.939441  0.000699
   MATMUL 13497  2.641218  0.000196
LDWEIGHTS 13497  1.168453  0.000087
     COPY   554  1.012716  0.001828
```
::::

`skip_warmup=False` ã«ã‚ˆã£ã¦ MATMUL ã¨ LDWEIGHTS ã¯å¤§å¹…ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆå›æ•°ã‚‚æ™‚é–“ã‚‚æ¸›å°‘ï¼‰ã€‚MATMUL ã¯ 21,582 å›ã‹ã‚‰ 13,497 å›ã¸ 37% å‰Šæ¸›ã€æ™‚é–“ã‚‚ 10.94 ãƒŸãƒªç§’ã‹ã‚‰ 2.64 ãƒŸãƒªç§’ã¸ 76% å‰Šæ¸›ã•ã‚Œã¦ã„ã¾ã™ã€‚LDWEIGHTS ã‚‚åŒæ§˜ã« 36% ã®å›æ•°å‰Šæ¸›ã€76% ã®æ™‚é–“å‰Šæ¸›ã‚’é”æˆã—ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ä¸€æ–¹ã§ã€ACTIVATE ã¨ COPY ãŒå¢—åŠ ã—ã¦ã„ã¾ã™ã€‚ACTIVATE ã¯æ™‚é–“ãŒ 1.65 ãƒŸãƒªç§’ã‹ã‚‰ 2.94 ãƒŸãƒªç§’ã¸ 78% å¢—åŠ ã€COPY ã¯ 0.03 ãƒŸãƒªç§’ã‹ã‚‰ 1.01 ãƒŸãƒªç§’ã¸ãªã‚“ã¨ 3814% å¢—åŠ ã—ã¦ã„ã¾ã™ã€‚ãƒˆãƒ¼ã‚¿ãƒ«ã§ã¯é…ããªã‚Šã¾ã—ãŸã€‚

:::message
è¦³æ¸¬ã•ã‚Œã‚‹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœã ã‘è¦‹ã¦ã‚‚å¤§ã—ãŸé•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ãŒå†…éƒ¨ã® Operation ã®å‚¾å‘ã¯è¨­å®šä¸€ã¤ã§å¤§ããå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã­ã€‚
:::

### 2.4 custom_call ã®æ¶ˆå¤±

`custom_call` ã®å¤‰åŒ–ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```python
# custom_call ã®æ¯”è¼ƒ
sql_custom = """
SELECT
    name,
    COUNT(*) as count,
    SUM(dur) / 1e6 as total_ms,
    AVG(dur) / 1e6 as avg_ms
FROM slice
WHERE name LIKE 'custom_call%'
GROUP BY name
ORDER BY avg_ms DESC
"""

print("Baseline (skip_warmup=True) - custom_call:")
df_baseline_custom = tp_baseline.query(sql_custom).as_pandas_dataframe()
print(df_baseline_custom.to_string(index=False))

print("\nWarmup (skip_warmup=False) - custom_call:")
df_warmup_custom = tp_warmup.query(sql_custom).as_pandas_dataframe()
print(df_warmup_custom.to_string(index=False))
```

::::details çµæœ
```
Baseline (skip_warmup=True) - custom_call:
                 name count  total_ms    avg_ms
custom_call.17_sg0002    36  7.028449  0.195235
custom_call.15_sg0002    54  0.085729  0.001588
custom_call.16_sg0002    36  0.002409  0.000067
custom_call.14_sg0002    36   0.00111  0.000031

Warmup (skip_warmup=False) - custom_call:
Empty DataFrame
Columns: [name, count, total_ms, avg_ms]
Index: []
```
::::

`custom_call` ãŒæ¶ˆãˆã¾ã—ãŸã€‚ã“ã‚Œã¯ã€`skip_warmup=False` ã«ã‚ˆã£ã¦ã€ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ¼ãƒãƒ«ãŒäº‹å‰ã«æœ€é©åŒ–ã•ã‚Œã€ä½ãƒ¬ãƒ™ãƒ«ã® Neuron å‘½ä»¤ï¼ˆMATMULã€LDWEIGHTS ãªã©ï¼‰ã«å¤‰æ›ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã—ã¦ã„ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚

:::message alert
ã•ã¦ã€ã“ã‚Œä»¥ä¸Šç‰¹ã«æ”¹å–„ã®æ‰‹ç«‹ã¦ãŒè¦‹å½“ãŸã‚Šã¾ã›ã‚“ã€‚ã€‚ä»¥å‰ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®ã‚¹ã‚¤ãƒ¼ãƒ—ã§å¯èƒ½ãªè¨­å®šã«ã¤ã„ã¦ã¯è‰²ã€…ã¨å®Ÿé¨“ã‚’ã—ã¦ã„ã¾ã™ã€‚ãã‚‚ãã‚‚ã‚ˆãè€ƒãˆã‚‹ã¨ Neuron Profiler ã§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ¼ã‚¿ãƒ«ã®ãƒˆãƒ¬ãƒ¼ã‚¹æ™‚é–“ãŒ 16-17ms ãªã®ã§å…¨ä½“ã¨æ¯”ã¹ã¦åœ§å€’çš„ã«çŸ­ã„ã®ã§ã¯ï¼Ÿã¨ã“ã“ã§æ°—ã¥ãã¾ã—ãŸã€‚
:::

## Phase 3: Python å´ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

### 3.1 æ¸¬å®šå¯¾è±¡ã®ç†è§£

ã¾ãšã€ä»Šå›ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§æ¸¬å®šã—ã¦ã„ã‚‹ã€Œãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã€ãŒä½•ã‚’æŒ‡ã™ã®ã‹æ˜ç¢ºã«ã—ã¾ã™ã€‚

**æ¸¬å®šå¯¾è±¡: 1 ã‚¯ã‚¨ãƒªï¼ˆ20 å€™è£œæ–‡æ›¸ã®ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰ã‚’å‡¦ç†ã™ã‚‹æ™‚é–“**

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆconfig.yamlï¼‰ã‚’è¦‹ã‚‹ã¨ã€ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

```yaml
reranker:
  search_num: 20        # 1 ã‚¯ã‚¨ãƒªã‚ãŸã‚Š 20 å€™è£œæ–‡æ›¸
  batch_size: 8         # 8 ãƒšã‚¢ãšã¤ãƒãƒƒãƒå‡¦ç†

vllm:
  max_num_seqs: 4       # vLLM ã®åŒæ™‚å‡¦ç†æ•°
```

ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœã¨ã—ã¦ã€10 ã‚¯ã‚¨ãƒªã®åˆè¨ˆæ™‚é–“ã¯ 2,992 ãƒŸãƒªç§’ã€1 ã‚¯ã‚¨ãƒªã‚ãŸã‚Šå¹³å‡ 299.2 ãƒŸãƒªç§’ï¼ˆç´„ 300 ãƒŸãƒªç§’ï¼‰ã¨ãªã‚Šã¾ã—ãŸã€‚

ã“ã® 300 ãƒŸãƒªç§’ã®å†…è¨³ã‚’ç†è§£ã™ã‚‹ãŸã‚ã€1 ã‚¯ã‚¨ãƒªã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’æ•´ç†ã—ã¾ã™ã€‚

```
1 ã‚¯ã‚¨ãƒªã®å‡¦ç†ãƒ•ãƒ­ãƒ¼:
  ã‚¯ã‚¨ãƒªæ–‡ Ã— 20 å€™è£œæ–‡æ›¸ = 20 ãƒšã‚¢ã®ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°
    â†“
  20 ãƒšã‚¢ Ã· batch_size=8 = 3 ãƒãƒƒãƒã«åˆ†å‰²
    â†“
  ãƒãƒƒãƒ 1: 8 ãƒšã‚¢ â†’ vLLM ã§å‡¦ç†
  ãƒãƒƒãƒ 2: 8 ãƒšã‚¢ â†’ vLLM ã§å‡¦ç†
  ãƒãƒƒãƒ 3: 4 ãƒšã‚¢ â†’ vLLM ã§å‡¦ç†ï¼ˆç«¯æ•°ï¼‰
    â†“
  åˆè¨ˆ: ç´„ 300 ãƒŸãƒªç§’
```

ã“ã® 300 ãƒŸãƒªç§’ã¨ã€AWS Neuron Profiler ã§æ¸¬å®šã•ã‚ŒãŸ 17.53 ãƒŸãƒªç§’ï¼ˆNeuron è¨ˆç®—æ™‚é–“ï¼‰ã¨ã®é–“ã«å¤§ããªä¹–é›¢ãŒã‚ã‚‹ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã€‚å·®åˆ†ã® 282.47 ãƒŸãƒªç§’ï¼ˆ94.1%ï¼‰ã¯ã©ã“ã«æ¶ˆãˆãŸã®ã§ã—ã‚‡ã†ã‹ã€‚

ä»¥ä¸‹ã®å›³ã¯ã€1 ã‚¯ã‚¨ãƒªï¼ˆ20 å€™è£œæ–‡æ›¸ï¼‰ã®å‡¦ç†æ™‚é–“ 300 ãƒŸãƒªç§’ã®æ§‹æˆã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

```mermaid
%%{init: {'theme':'dark','themeVariables': {'darkMode': true, 'background': '#0d1117', 'primaryColor': '#58a6ff', 'primaryTextColor': '#f0f6fc', 'primaryBorderColor': '#58a6ff', 'lineColor': '#58a6ff', 'secondaryColor': '#58a6ff', 'tertiaryColor': '#58a6ff', 'fontSize': '16px'}}}%%
flowchart TB
    subgraph query["1 ã‚¯ã‚¨ãƒªã®å‡¦ç†æ™‚é–“ 300 ms"]
        direction TB
        Q["ã‚¯ã‚¨ãƒªæ–‡ Ã— 20 å€™è£œæ–‡æ›¸<br/>= 20 ãƒšã‚¢ã®ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°"]
        Q --> D["20 ãƒšã‚¢ Ã· batch_size=8<br/>= 3 ãƒãƒƒãƒã«åˆ†å‰²"]
        D --> B1["ãƒãƒƒãƒ 1: 8 ãƒšã‚¢<br/>126 ms"]
        D --> B2["ãƒãƒƒãƒ 2: 8 ãƒšã‚¢<br/>126 ms"]
        D --> B3["ãƒãƒƒãƒ 3: 4 ãƒšã‚¢<br/>ç´„ 63 ms ç«¯æ•°"]
        B1 --> T["åˆè¨ˆ: ç´„ 315 ms"]
        B2 --> T
        B3 --> T
        T --> R["å®Ÿæ¸¬: 300 ms<br/>å·®åˆ† 15 ms ã¯ä¸¦åˆ—å‡¦ç†åŠ¹æœ"]
    end

    subgraph batch["1 ãƒãƒƒãƒ 126 ms ã®å†…è¨³"]
        direction TB
        S["Serialization<br/>66 ms - 52%"]
        DT["Data Transfer<br/>41 ms - 32%"]
        NC["Neuron è¨ˆç®—<br/>6 ms - 5%"]
        O["ãã®ä»–<br/>13 ms - 10%"]
    end

    style query fill:#0d1117,stroke:#58a6ff,stroke-width:3px,color:#f0f6fc
    style batch fill:#0d1117,stroke:#8957e5,stroke-width:3px,color:#f0f6fc
    style Q fill:#238636,stroke:#238636,stroke-width:2px,color:#ffffff
    style D fill:#1f6feb,stroke:#1f6feb,stroke-width:2px,color:#ffffff
    style B1 fill:#c93c37,stroke:#c93c37,stroke-width:2px,color:#ffffff
    style B2 fill:#c93c37,stroke:#c93c37,stroke-width:2px,color:#ffffff
    style B3 fill:#c93c37,stroke:#c93c37,stroke-width:2px,color:#ffffff
    style T fill:#da3633,stroke:#da3633,stroke-width:2px,color:#ffffff
    style R fill:#238636,stroke:#238636,stroke-width:2px,color:#ffffff
    style S fill:#8957e5,stroke:#8957e5,stroke-width:2px,color:#ffffff
    style DT fill:#da3633,stroke:#da3633,stroke-width:2px,color:#ffffff
    style NC fill:#238636,stroke:#238636,stroke-width:2px,color:#ffffff
    style O fill:#6e7681,stroke:#6e7681,stroke-width:2px,color:#f0f6fc
```

ã“ã®å›³ã‹ã‚‰ã€ä»¥ä¸‹ã®ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã¾ãšã€1 ã‚¯ã‚¨ãƒªã¯ 20 å€™è£œæ–‡æ›¸ã®ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å¿…è¦ã¨ã™ã‚‹ãŸã‚ã€20 ãƒšã‚¢ã®ã‚¯ã‚¨ãƒªæ–‡æ›¸ãƒšã‚¢ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚æ¬¡ã«ã€ã“ã‚Œã‚‰ã® 20 ãƒšã‚¢ã¯ batch_size=8 ã®è¨­å®šã«ã‚ˆã‚Š 3 ãƒãƒƒãƒã«åˆ†å‰²ã•ã‚Œã¾ã™ï¼ˆ8 ãƒšã‚¢ã€8 ãƒšã‚¢ã€4 ãƒšã‚¢ï¼‰ã€‚å„ãƒãƒƒãƒã®å‡¦ç†ã«ã¯ç´„ 126 ãƒŸãƒªç§’ã‹ã‹ã‚Šã€ã“ã®æ™‚é–“ã®å¤§éƒ¨åˆ†ï¼ˆ66 ãƒŸãƒªç§’ã€52%ï¼‰ã¯ Serialization ãŒå ã‚ã¦ã„ã¾ã™ã€‚ç†è«–ä¸Šã®åˆè¨ˆæ™‚é–“ã¯ 315 ãƒŸãƒªç§’ã§ã™ãŒã€å®Ÿæ¸¬å€¤ã¯ 300 ãƒŸãƒªç§’ã§ã‚ã‚Šã€ã“ã® 15 ãƒŸãƒªç§’ã®å·®åˆ†ã¯ vLLM ã® continuous batching ã«ã‚ˆã‚‹ä¸¦åˆ—å‡¦ç†åŠ¹æœã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

### 3.2 Python å´ã®å•é¡Œã«æ°—ã¥ã

AWS Neuron Profiler ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ã¨ã€MATMUL ã‚„ LDWEIGHTS ãªã©ã®æ“ä½œã¯ 10 ã‹ã‚‰ 15 ãƒŸãƒªç§’ç¨‹åº¦ã—ã‹è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã—ã‹ã—ã€å®Ÿéš›ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ã¯ 1 ã‚¯ã‚¨ãƒªã‚ãŸã‚Š 300 ãƒŸãƒªç§’ã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ã“ã®ä¹–é›¢ã‹ã‚‰ã€AWS Neuron Profiler ã¯ä¸€éƒ¨ã®ãƒãƒƒãƒã—ã‹ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦ã„ãªã„ã®ã§ã¯ãªã„ã‹ã¨ã„ã†ä»®èª¬ãŒç«‹ã¡ã¾ã—ãŸã€‚ã“ã®ä»®èª¬ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã€Python å´ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

### 3.3 line_profiler ã«ã‚ˆã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°

Python å´ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã€[line_profiler](https://github.com/pyutils/line_profiler) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯é–¢æ•°ã‚’è¡Œå˜ä½ã§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã§ãã‚‹å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã§ã€vLLM å´ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å¯è¦–åŒ–ã§ãã¾ã™ã€‚

```python
# profile_line.py
from line_profiler import LineProfiler

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å¯¾è±¡ã®é–¢æ•°ã« @profile ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä»˜ã‘ã‚‹
@profile
def run_reranker(llm, tokenizer, token_true_id, token_false_id, prefix_tokens, suffix_tokens):
    """Run reranker on queries - MAIN PROFILING TARGET"""

    # ... (å®Ÿéš›ã®å‡¦ç†)

    for query_idx, row in enumerate(rows[:num_queries]):
        # ã‚¯ã‚¨ãƒªå‡¦ç†
        prompts = build_prompts_for_vllm(pairs, tokenizer, prefix_tokens, suffix_tokens)

        # ãƒãƒƒãƒå‡¦ç†
        for s in range(0, len(prompts), batch_size):
            batch_prompts = prompts[s:s + batch_size]
            outputs = llm.generate(batch_prompts, sampling_params)  # â† ã“ã“ãŒé‡è¦
            query_outputs.extend(outputs)
```

å®Ÿè¡Œæ–¹æ³•ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```bash
$ kernprof -l -v profile_line.py
```

::::details çµæœ
```
Total time: 0.0317499 s
File: profile_line.py
Function: build_prompts_for_vllm at line 88

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
    88                                           @profile
    89                                           def build_prompts_for_vllm(pairs, tokenizer, prefix_tokens, suffix_tokens):
    90                                               """Build prompts with proper tokenization - PROFILING TARGET"""
    91        10          7.1      0.7      0.0      prompts = []
    92        10         13.0      1.3      0.0      budget = max_length - len(prefix_tokens) - len(suffix_tokens)
    93                                           
    94                                               # Tokenize pairs
    95        20      17804.3    890.2     56.1      enc = tokenizer(
    96        10          8.7      0.9      0.0          list(pairs),
    97        10          4.9      0.5      0.0          padding=False,
    98        10          4.2      0.4      0.0          truncation="longest_first",
    99        10          4.3      0.4      0.0          return_attention_mask=False,
   100        10          4.1      0.4      0.0          add_special_tokens=False,
   101        10         13.3      1.3      0.0          max_length=max(8, budget),
   102                                               )
   103                                           
   104                                               # Build final prompts: prefix + content + suffix
   105       210        132.1      0.6      0.4      for ids in enc["input_ids"]:
   106       200        277.0      1.4      0.9          final_ids = prefix_tokens + ids + suffix_tokens
   107       200      13355.7     66.8     42.1          text = tokenizer.decode(final_ids, skip_special_tokens=False)
   108       200        109.9      0.5      0.3          prompts.append(text)
   109                                           
   110        10         11.4      1.1      0.0      return prompts

Total time: 3.40323 s
File: profile_line.py
Function: run_reranker at line 113

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
   113                                           @profile
   114                                           def run_reranker(llm, tokenizer, token_true_id, token_false_id, prefix_tokens, suffix_tokens):
   115                                               """Run reranker on queries - MAIN PROFILING TARGET"""
   116                                           
   117         1          4.2      4.2      0.0      import vllm
   118         1        141.5    141.5      0.0      from vllm import SamplingParams
   119                                           
   120                                               # Get use_tqdm setting from benchmark config
   121         1          1.6      1.6      0.0      use_tqdm = benchmark_config.get('use_tqdm', True)
   122                                           
   123                                               # Create SamplingParams
   124         2        126.7     63.3      0.0      sampling_params = SamplingParams(
   125         1          1.2      1.2      0.0          max_tokens=1,
   126         1          1.0      1.0      0.0          temperature=0.0,
   127         1          0.7      0.7      0.0          logprobs=20,
   128         1          0.7      0.7      0.0          detokenize=True,
   129         1          0.9      0.9      0.0          allowed_token_ids=[token_true_id, token_false_id]
   130                                               )
   131                                           
   132         2        311.8    155.9      0.0      logger.info(f"SamplingParams configured: max_tokens=1, "
   133         1          1.4      1.4      0.0                  f"allowed_tokens=[{token_ids['true']}, {token_ids['false']}]")
   134                                           
   135                                               # Process each query
   136         1          1.0      1.0      0.0      total_processed = 0
   137        11         14.4      1.3      0.0      for query_idx, row in enumerate(rows[:num_queries]):
   138        10         14.5      1.5      0.0          query = row["query"]
   139                                           
   140                                                   # Get candidates
   141       210         95.5      0.5      0.0          candidates = [
   142       200        208.8      1.0      0.0              row[f"answer_{i}"]
   143       210         91.7      0.4      0.0              for i in range(search_num)
   144       200        142.5      0.7      0.0              if f"answer_{i}" in row
   145                                                   ]
   146                                           
   147                                                   # Format query-document pairs
   148        10        534.5     53.4      0.0          pairs = [format_instruction(query, doc) for doc in candidates[:search_num]]
   149                                           
   150                                                   # Build prompts with tokenization
   151        10      32548.9   3254.9      1.0          prompts = build_prompts_for_vllm(pairs, tokenizer, prefix_tokens, suffix_tokens)
   152                                           
   153                                                   # Process in batches
   154        10        295.1     29.5      0.0          query_outputs = []
   155        40         37.1      0.9      0.0          for s in range(0, len(prompts), batch_size):
   156        30         46.1      1.5      0.0              batch_prompts = prompts[s:s + batch_size]
   157        30    3367842.2 112261.4     99.0              outputs = llm.generate(batch_prompts, sampling_params, use_tqdm=use_tqdm)
   158        30         40.5      1.4      0.0              query_outputs.extend(outputs)
   159                                           
   160        10          7.8      0.8      0.0          total_processed += len(query_outputs)
   161                                           
   162        10          7.0      0.7      0.0          if query_idx == 0:
   163                                                       # Show first result for verification
   164         1        215.6    215.6      0.0              logger.info(f"Query 1: {query[:80]}...")
   165         2        137.4     68.7      0.0              logger.info(f"Generated {len(query_outputs)} scores for "
   166         1          3.8      3.8      0.0                         f"{len(candidates[:search_num])} candidates")
   167         1          0.9      0.9      0.0              if query_outputs:
   168         1          0.8      0.8      0.0                  first_output = query_outputs[0]
   169         2        131.1     65.5      0.0                  logger.info(f"First output: {first_output.outputs[0].text} "
   170         1          3.1      3.1      0.0                             f"(token_ids={first_output.outputs[0].token_ids})")
   171                                           
   172         1        213.3    213.3      0.0      logger.info(f"Profiling completed: processed {total_processed} reranker pairs")
   173         1          2.5      2.5      0.0      return total_processed
```
::::

99.0% ã®æ™‚é–“ãŒ `llm.generate()` ã®ä¸­ã§æ¶ˆè²»ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚

ã“ã“ã§ã€Neuron Profiler ã®ãƒˆãƒ¬ãƒ¼ã‚¹çµæœã¨ line_profiler ã®çµæœã‚’æ¯”è¼ƒã—ã¦ã¿ã¾ã™ã€‚

| æ¸¬å®šæ–¹æ³• | æ¸¬å®šç¯„å›² | Neuronè¨ˆç®—æ™‚é–“ | Python/vLLMã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ |
|---------|---------|---------------|------------------------|
| Neuron Profiler | Neuron ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã®ã¿ | 17.53ms | æ¸¬å®šä¸å¯ |
| line_profiler | Python å…¨ä½“ | - | 3.4032 ç§’ï¼ˆ99.0%ï¼‰|

`llm.generate()` ãŒ 3.4032 ãƒŸãƒªç§’ï¼ˆ99.0%ï¼‰ã‚’å ã‚ã¦ã„ã¾ã™ã€‚ãã®ä¸­ã§ Neuron è¨ˆç®—ã¯ 17 ãƒŸãƒªç§’ï¼ˆ0.5%ï¼‰ã®ã¿ã§ã™ã€‚

### 3.3 ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã®æ­£ä½“

::::details ã•ã‚‰ã«è©³ç´°ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœ

kernprof ã«ã¯ `-p / --prof-mod` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã€ã“ã‚Œã‚’ä½¿ãˆã°ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚„ãƒ¢ãƒ³ã‚­ãƒ¼ãƒ‘ãƒƒãƒãªã—ã§å¤–éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é–¢æ•°ã‚’ç›´æ¥ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã§ãã¾ã™ã€‚

```bash
kernprof -l -v -p vllm.v1.engine profile_line.py
```

vLLM v1 ã‚¨ãƒ³ã‚¸ãƒ³ã®å†…éƒ¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœã‹ã‚‰ã€é‡è¦ãªãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã—ãŸã€‚

**åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚º (1å›ã®ã¿å®Ÿè¡Œ)**:

```
Total time: 120.526 s
File: vllm/v1/engine/llm_engine.py
Function: LLMEngine.from_engine_args

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
   175         1   11381814.4 1.14e+07      9.4  vllm_config = engine_args.create_engine_config()
   183         2  109144284.5 5.46e+07     90.6  return cls(vllm_config, executor_class, ...)
```

åˆæœŸåŒ–æ™‚é–“ã® 90.6% (109ç§’) ã¯ `LLMEngine.__init__()` ã§æ¶ˆè²»ã•ã‚Œã¦ã„ã¾ã™ã€‚

```
Total time: 109.144 s
File: vllm/v1/engine/llm_engine.py
Function: LLMEngine.__init__

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
   109         2  108646975.1 5.43e+07     99.5  self.engine_core = EngineCoreClient.make_client(...)
    89         1     469858.2 469858.2      0.4  tokenizer = cached_tokenizer_from_config()
    91         1       5856.7   5856.7      0.0  self.input_processor = InputProcessor(...)
```

åˆæœŸåŒ–ã® 99.5% ã¯ `EngineCoreClient.make_client()` ã§ã€ã“ã‚Œã¯ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

1. **Neuron ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**: 40-50ç§’ (37-46%)
   - torch_neuronx ã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
   - Neuron ã‚³ã‚¢ã¸ã®é…ç½®ã¨æœ€é©åŒ–

2. **KV ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆæœŸåŒ–**: 10-15ç§’ (9-14%)
   - GPU ãƒ¡ãƒ¢ãƒªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°
   - `determine_available_memory()` ã®å®Ÿè¡Œ

3. **ãƒ¢ãƒ‡ãƒ«ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—**: 15-20ç§’ (14-18%)
   - ãƒ†ã‚¹ãƒˆæ¨è«–ã®å®Ÿè¡Œ
   - Neuron ã‚°ãƒ©ãƒ•ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”Ÿæˆ

4. **ZMQ ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯**: 10-15ç§’ (9-14%)
   - Ray ãƒ—ãƒ­ã‚»ã‚¹é–“ã®é€šä¿¡ç¢ºç«‹
   - tensor_parallel_size=2 ãªã®ã§ 2å›å®Ÿè¡Œ

**æ¨è«–ãƒ•ã‚§ãƒ¼ã‚º (ç¹°ã‚Šè¿”ã—å®Ÿè¡Œ)**:

```
Total time: 3.816 s
File: profile_line.py
Function: run_reranker

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
   157        30    3781560.3 126052.0     99.1  outputs = llm.generate(batch_prompts, ...)
   151        10      31179.4   3117.9      0.8  prompts = build_prompts_for_vllm(...)
```

æ¨è«–æ™‚é–“ã® 99.1% ã¯ `llm.generate()` ã§æ¶ˆè²»ã•ã‚Œã¦ãŠã‚Šã€ãƒãƒƒãƒã‚ãŸã‚Šå¹³å‡ 126.05 ãƒŸãƒªç§’ã‹ã‹ã£ã¦ã„ã¾ã™ã€‚

::::


### 3.4 llm.generate() ã®å†…éƒ¨æ§‹é€ 

vLLM ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª¿æŸ»ã—ã¦ã€126 ãƒŸãƒªç§’ãŒã©ã“ã§æ¶ˆè²»ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç‰¹å®šã—ã¾ã—ãŸã€‚vllm-neuron ã¯ NxD Inference (neuronx-distributed-inference) ã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«å®Ÿè¡Œã‚’è¡Œã„ã¾ã™ ([å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/libraries/nxd-inference/vllm/index.html))ã€‚

vLLM v1 ã‚¨ãƒ³ã‚¸ãƒ³ã¯ Ray ã‚’ä½¿ç”¨ã—ãŸãƒãƒ«ãƒãƒ—ãƒ­ã‚»ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

```
ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ (API Server)
    â†“ ZMQ (PUSH)
EngineCore ãƒ—ãƒ­ã‚»ã‚¹ (Ray)
    â†“
Neuron Worker ãƒ—ãƒ­ã‚»ã‚¹
    â†“
NeuronCore (å®Ÿéš›ã®è¨ˆç®—)
```

ã“ã®æ§‹é€ ã«ã‚ˆã‚Šã€å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿è»¢é€ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã®è©³ç´°:

```python
# vllm/entrypoints/llm.py
def generate(self, prompts, sampling_params):
    # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
    self._validate_and_add_requests(prompts, sampling_params)

    # ã‚¨ãƒ³ã‚¸ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†
    outputs = self._run_engine(use_tqdm=True)
    return outputs

def _run_engine(self, use_tqdm=True):
    # æœªå®Œäº†ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚‹é™ã‚Šãƒ«ãƒ¼ãƒ—
    while self.llm_engine.has_unfinished_requests():
        step_outputs = self.llm_engine.step()  # â† 1ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ
        for output in step_outputs:
            if output.finished:
                outputs.append(output)
    return sorted(outputs, key=lambda x: int(x.request_id))
```

126 ãƒŸãƒªç§’ã®å†…è¨³ã‚’æ¨å®šã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

| ãƒ•ã‚§ãƒ¼ã‚º | æ¨å®šæ™‚é–“ | å‰²åˆ | èª¬æ˜ |
|---------|---------|------|------|
| **RequestOutput ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³** | **66ms** | **52%** | EngineCoreOutput â†’ MessagePack å½¢å¼ã¸ã®å¤‰æ› |
| ãƒ‡ãƒ¼ã‚¿è»¢é€ (Ray IPC) | 41ms | 32% | ZMQ ã‚’ä»‹ã—ãŸãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ |
| Neuron è¨ˆç®— | 6ms | 5% | å®Ÿéš›ã®ãƒ¢ãƒ‡ãƒ«æ¨è«– (NeuronCore ä¸Š) |
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚° | 8ms | 6% | ãƒãƒƒãƒãƒ³ã‚°ã€ãƒ¡ãƒ¢ãƒªç®¡ç† |
| ãã®ä»– | 5ms | 4% | OutputProcessor ãªã© |

**æœ€å¤§ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯: RequestOutput ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ (52%)**

vLLM ã¯ Ray RPC ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚»ã‚¹é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã—ã¾ã™ã€‚ã“ã®éš›ã€Python ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ MessagePack å½¢å¼ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã“ã‚ŒãŒæœ€å¤§ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¨ãªã£ã¦ã„ã¾ã™ã€‚

### 3.5 ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®è©³ç´°

æœ€å¤§ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ (52%) ã§ã‚ã‚‹ã€ŒRequestOutput ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã€ã®æ­£ä½“ã‚’èª¿æŸ»ã—ã¾ã—ãŸã€‚

vLLM ã¯ `EngineCoreOutput` ã¨ã„ã†æ§‹é€ ä½“ã‚’ä½¿ç”¨ã—ã¦ã€Neuron ã‹ã‚‰ã®å‡ºåŠ›ã‚’è¡¨ç¾ã—ã¾ã™ã€‚

```python
# vllm/v1/engine/__init__.py
class EngineCoreOutput(msgspec.Struct):
    request_id: str                           # ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ID
    new_token_ids: list[int]                  # æ–°è¦ç”Ÿæˆãƒˆãƒ¼ã‚¯ãƒ³ ID
    new_logprobs: LogprobsLists | None        # ãƒ­ã‚°ãƒ—ãƒ­ãƒãƒ“ãƒªãƒ†ã‚£ (NumPy é…åˆ—)
    new_prompt_logprobs_tensors: LogprobsTensors | None  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ­ã‚°ãƒ—ãƒ­ãƒãƒ“ãƒªãƒ†ã‚£
    pooling_output: torch.Tensor | None       # ãƒ—ãƒ¼ãƒªãƒ³ã‚°å‡ºåŠ›
    finish_reason: FinishReason | None        # çµ‚äº†ç†ç”±
    stop_reason: int | str | None             # åœæ­¢ç†ç”±
    events: list[EngineCoreEvent] | None      # ã‚¨ãƒ³ã‚¸ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    kv_transfer_params: dict[str, Any] | None # KV è»¢é€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    trace_headers: Mapping[str, str] | None   # ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼
    # ... ãã®ä»–ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
```

**LogprobsLists ã®æ§‹é€ ** (ãƒ­ã‚°ãƒ—ãƒ­ãƒãƒ“ãƒªãƒ†ã‚£ãŒæœ€ã‚‚å¤§ãã„ãƒ‡ãƒ¼ã‚¿):

```python
# vllm/v1/outputs.py
class LogprobsLists(NamedTuple):
    logprob_token_ids: np.ndarray    # [num_reqs Ã— num_tokens, max_logprobs + 1]
    logprobs: np.ndarray             # [num_reqs Ã— num_tokens, max_logprobs + 1]
    sampled_token_ranks: np.ndarray  # [num_reqs Ã— num_tokens]
```

**ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã®è¨ˆç®—ä¾‹** (ãƒãƒƒãƒã‚µã‚¤ã‚º=4, max_num_logprobs=20):

```
logprob_token_ids: 4 Ã— 1 Ã— 21 Ã— 4bytes (int32) = 336 bytes
logprobs:          4 Ã— 1 Ã— 21 Ã— 4bytes (float32) = 336 bytes
sampled_token_ranks: 4 Ã— 1 Ã— 4bytes (int32) = 16 bytes
åˆè¨ˆ: ç´„ 688 bytes/ãƒãƒƒãƒ
```

ãƒªãƒ©ãƒ³ã‚«ãƒ¼ã¯ max_tokens=1 ãªã®ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã¯æ¯”è¼ƒçš„å°ã•ã„ã§ã™ã€‚ã—ã‹ã—ã€200 ãƒšã‚¢ Ã— 688 bytes = ç´„ 138KB ã®ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ­ã‚»ã‚¹**:

1. **EngineCore ãƒ—ãƒ­ã‚»ã‚¹**: `EngineCoreOutput` ã‚’ç”Ÿæˆ
2. **MsgpackEncoder**: MessagePack å½¢å¼ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
   - Zero-copy è»¢é€ (256 ãƒã‚¤ãƒˆä»¥ä¸Šã®ãƒ†ãƒ³ã‚½ãƒ«/é…åˆ—)
   - ZMQ multipart é€ä¿¡
3. **ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹**: MsgpackDecoder ã§ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
4. **OutputProcessor**: `RequestOutput` ã«å¤‰æ›

ã“ã®ä¸€é€£ã®å‡¦ç†ãŒ 66ms (52%) ã‚’æ¶ˆè²»ã—ã¦ã„ã¾ã™ã€‚

**ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®è¦å› **

ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¯ã€è¤‡æ•°ã®è¦å› ãŒé‡ãªã£ã¦ç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

ç¬¬ä¸€ã«ã€Tensor ã‹ã‚‰ NumPy ã¸ã®å¤‰æ›ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å‡¦ç†ã§ã¯ã€NeuronCore ã‹ã‚‰ CPU ã¸ã®ãƒ‡ãƒ¼ã‚¿è»¢é€ãŒç™ºç”Ÿã—ã€å¤§ããªã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¨ãªã‚Šã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€LogprobsTensors ã‚¯ãƒ©ã‚¹ã® tolists ãƒ¡ã‚½ãƒƒãƒ‰ã«ãŠã„ã¦ã€logprob_token_idsã€logprobsã€selected_token_ranks ã®å„ãƒ†ãƒ³ã‚½ãƒ«ãŒ cpu() ãƒ¡ã‚½ãƒƒãƒ‰ã§ CPU ã«è»¢é€ã•ã‚Œã€numpy() ãƒ¡ã‚½ãƒƒãƒ‰ã§ NumPy é…åˆ—ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚

```python
LogprobsTensors.tolists():
    return LogprobsLists(
        self.logprob_token_ids.cpu().numpy(),  # GPU â†’ CPU è»¢é€
        self.logprobs.cpu().numpy(),
        self.selected_token_ranks.cpu().numpy(),
    )
```

ç¬¬äºŒã«ã€MessagePack ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€è¤‡æ•°ã®ãƒãƒƒãƒ•ã‚¡ã‚’å€‹åˆ¥ã«å‡¦ç†ã—ã¦ã„ã¾ã™ã€‚å„ EngineCoreOutput ãŒå€‹åˆ¥ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ãŸã‚ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒ 200 å›ç™ºç”Ÿã—ã¾ã™ã€‚

ç¬¬ä¸‰ã«ã€ZMQ multipart é€ä¿¡ã§ã¯ã€è¤‡æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒ¼ãƒˆãŒé€ä¿¡ã•ã‚Œã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒç™ºç”Ÿã—ã¾ã™ã€‚

æœ€å¾Œã«ã€OutputProcessor ã®å†å‡¦ç†ã¨ã—ã¦ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¾Œã«å†åº¦ CompletionOutput ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚‚ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã®ä¸€å› ã¨ãªã£ã¦ã„ã¾ã™ã€‚

### 3.6 ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®å…¨ä½“åƒ

126 ãƒŸãƒªç§’/ãƒãƒƒãƒã®å†…è¨³ã‚’å›³ç¤ºã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```mermaid
%%{init: {'theme':'dark','themeVariables': {'darkMode': true, 'background': '#0d1117', 'primaryColor': '#58a6ff', 'primaryTextColor': '#f0f6fc', 'primaryBorderColor': '#58a6ff', 'lineColor': '#58a6ff', 'secondaryColor': '#58a6ff', 'tertiaryColor': '#58a6ff', 'fontSize': '16px'}}}%%
flowchart TB
    subgraph total["ãƒãƒƒãƒãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ 126 ms ãƒãƒƒãƒ"]
        direction TB
        A["ãƒˆãƒ¼ã‚¯ãƒ³åŒ–<br/>3.1 ms - 2.5%"]
        B["vLLM ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯<br/>117 ms - 92.9%"]
        C["Neuron è¨ˆç®—<br/>6 ms - 4.8%"]
    end

    B --> B1["Serialization<br/>66 ms - 52.4%"]
    B --> B2["Data Transfer<br/>41 ms - 32.5%"]
    B --> B3["Scheduling<br/>8 ms - 6.3%"]
    B --> B4["ãã®ä»–<br/>2 ms - 1.6%"]

    B1 --> B1a["EngineCoreOutput â†’ MessagePack"]
    B1 --> B1b["Tensor â†’ NumPy å¤‰æ›"]
    B1 --> B1c["ZMQ multipart é€ä¿¡"]

    B2 --> B2a["Ray IPC ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰"]
    B2 --> B2b["ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡"]

    C --> C1["MATMUL: 2.6 ms"]
    C --> C2["LDWEIGHTS: 1.2 ms"]
    C --> C3["ACTIVATE: 1.5 ms"]
    C --> C4["ãã®ä»–: 0.7 ms"]

    style total fill:#0d1117,stroke:#58a6ff,stroke-width:3px,color:#f0f6fc
    style A fill:#238636,stroke:#238636,stroke-width:2px,color:#ffffff
    style B fill:#c93c37,stroke:#c93c37,stroke-width:2px,color:#ffffff
    style C fill:#1f6feb,stroke:#1f6feb,stroke-width:2px,color:#ffffff
    style B1 fill:#8957e5,stroke:#8957e5,stroke-width:2px,color:#ffffff
    style B2 fill:#da3633,stroke:#da3633,stroke-width:2px,color:#ffffff
    style B1a fill:#6e7681,stroke:#6e7681,stroke-width:1px,color:#f0f6fc
    style B1b fill:#6e7681,stroke:#6e7681,stroke-width:1px,color:#f0f6fc
    style B1c fill:#6e7681,stroke:#6e7681,stroke-width:1px,color:#f0f6fc
    style B2a fill:#6e7681,stroke:#6e7681,stroke-width:1px,color:#f0f6fc
    style B2b fill:#6e7681,stroke:#6e7681,stroke-width:1px,color:#f0f6fc
    style C1 fill:#6e7681,stroke:#6e7681,stroke-width:1px,color:#f0f6fc
    style C2 fill:#6e7681,stroke:#6e7681,stroke-width:1px,color:#f0f6fc
    style C3 fill:#6e7681,stroke:#6e7681,stroke-width:1px,color:#f0f6fc
    style C4 fill:#6e7681,stroke:#6e7681,stroke-width:1px,color:#f0f6fc
```

**é‡è¦ãªç™ºè¦‹**:

ã¾ãšã€Neuron è¨ˆç®—ã¯éå¸¸ã«é«˜é€Ÿã§ã‚ã‚Šã€ã‚ãšã‹ 6 msï¼ˆ4.8%ï¼‰ã§å‡¦ç†ãŒå®Œäº†ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã«ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãŒãªã„ã“ã¨ã‚’ç¤ºã—ã¦ãŠã‚Šã€å®Ÿéš›ã®è¨ˆç®—æ™‚é–“ã¯æ¥µã‚ã¦çŸ­ã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ä¸€æ–¹ã€vLLM ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒæ”¯é…çš„ã§ã€117 msï¼ˆ92.9%ï¼‰ã‚’å ã‚ã¦ã„ã¾ã™ã€‚ãã®å†…è¨³ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãŒ 66 msï¼ˆ52.4%ï¼‰ã€ãƒ‡ãƒ¼ã‚¿è»¢é€ãŒ 41 msï¼ˆ32.5%ï¼‰ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãŒ 8 msï¼ˆ6.3%ï¼‰ã¨ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã®ã“ã¨ã‹ã‚‰ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰æ¯”ç‡ã¯ç´„ 20 å€ã«é”ã—ã¦ãŠã‚Šã€ã‚ãšã‹ 6 ms ã®è¨ˆç®—ã®ãŸã‚ã« 120 ms ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ vLLM ã®ãƒãƒ«ãƒãƒ—ãƒ­ã‚»ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«èµ·å› ã™ã‚‹æ§‹é€ çš„ãªå•é¡Œã§ã™ã€‚

## Phase 4: æœ€é©åŒ–ã®å¯èƒ½æ€§

### 4.1 çŸ­æœŸçš„ãªæœ€é©åŒ–ï¼ˆå®Ÿè£…é›£åº¦ï¼šä½ï¼‰

ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœã‹ã‚‰ã€å®Ÿè£…ãŒå®¹æ˜“ã§åŠ¹æœãŒæœŸå¾…ã§ãã‚‹æœ€é©åŒ–æ‰‹æ³•ã‚’æ¤œè¨ã—ã¾ã™ã€‚

**ãƒãƒƒãƒã‚µã‚¤ã‚ºã®å¢—åŠ **

ç¾åœ¨ã®è¨­å®šã§ã¯ batch_size=4 ã¨ãªã£ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã‚’å¢—ã‚„ã™ã“ã¨ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å„Ÿå´ã§ãã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€vLLM ã® max_num_seqs ã‚’ 4 ã‹ã‚‰ 8 ã«ã€max_num_batched_tokens ã‚’ 256 ã‹ã‚‰ 512 ã«å¢—ã‚„ã—ã¾ã™ã€‚

```yaml
# config.yaml
vllm:
  max_num_seqs: 8  # 4 â†’ 8
  max_num_batched_tokens: 512  # 256 â†’ 512
```

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€ã‚ˆã‚Šå¤§ããªãƒãƒƒãƒã§ã®åŠ¹ç‡çš„ãªå‡¦ç†ãŒå¯èƒ½ã«ãªã‚Šã€æ¨å®šæ”¹å–„ç‡ã¯ 10 ã‹ã‚‰ 15% ã§ã™ã€‚ãŸã ã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¨ã—ã¦ã€ã‚ˆã‚Šå¤šãã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¾…ã¤ãŸã‚ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãŒå¢—åŠ ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**Zero-copy threshold ã®èª¿æ•´**

vLLM ã¯ MessagePack ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹éš›ã€ä¸€å®šã‚µã‚¤ã‚ºä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ Zero-copy è»¢é€ã‚’è¡Œã„ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é–¾å€¤ã¯ 256 ãƒã‚¤ãƒˆã§ã™ãŒã€ã“ã‚Œã‚’ 4096 ãƒã‚¤ãƒˆã«å¢—ã‚„ã™ã“ã¨ã§ã€å°ã•ãªãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚

```bash
# ç’°å¢ƒå¤‰æ•°ã§è¨­å®š
export VLLM_MSGPACK_ZERO_COPY_THRESHOLD=4096  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 256
```

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€å°ã•ãªãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ãŒå‰Šæ¸›ã•ã‚Œã€æ¨å®šæ”¹å–„ç‡ã¯ 5 ã‹ã‚‰ 10% ã§ã™ã€‚

**ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç„¡åŠ¹åŒ–**

ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ãªã„å ´åˆã€trace_headers ã®é€ä¿¡ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ã§ã€è¾æ›¸ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚ã“ã‚Œã«ã¯ vLLM ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã€trace_headers ã‚’æ¡ä»¶ä»˜ãã§é€ä¿¡ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```python
# vLLM ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£
# trace_headers: Mapping[str, str] | None = None
# â†“
# trace_headers ã‚’æ¡ä»¶ä»˜ãã§é€ä¿¡
```

ã“ã®æœ€é©åŒ–ã«ã‚ˆã‚Šã€ãƒˆãƒ¬ãƒ¼ã‚¹éä½¿ç”¨æ™‚ã« 5 ã‹ã‚‰ 10% ã®æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã€‚

### 4.2 ä¸­æœŸçš„ãªæœ€é©åŒ–ï¼ˆå®Ÿè£…é›£åº¦ï¼šä¸­ï¼‰

ä¸­æœŸçš„ãªæœ€é©åŒ–ã¨ã—ã¦ã€å®Ÿè£…ã«ã‚„ã‚„æ‰‹é–“ãŒã‹ã‹ã‚‹ã‚‚ã®ã®ã€å¤§ããªåŠ¹æœãŒæœŸå¾…ã§ãã‚‹æ‰‹æ³•ã‚’æ¤œè¨ã—ã¾ã™ã€‚

**ä¸¦åˆ—åˆæœŸåŒ–**

ç¾åœ¨ã€tensor_parallel_size=2 ã®è¨­å®šã§ã¯ã€ã‚¨ãƒ³ã‚¸ãƒ³ãŒé †æ¬¡åˆæœŸåŒ–ã•ã‚Œã¦ãŠã‚Šã€åˆè¨ˆ 108 ç§’ã‹ã‹ã£ã¦ã„ã¾ã™ã€‚å„ã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–ã«ã¯ 50 ã‹ã‚‰ 60 ç§’ã‹ã‹ã‚‹ãŸã‚ã€2 ã¤ã®ã‚¨ãƒ³ã‚¸ãƒ³ã‚’é †æ¬¡åˆæœŸåŒ–ã™ã‚‹ã¨ç´„ 108 ç§’ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚’ä¸¦åˆ—åˆæœŸåŒ–ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€åˆæœŸåŒ–æ™‚é–“ã‚’å¤§å¹…ã«å‰Šæ¸›ã§ãã¾ã™ã€‚

```python
# ç¾åœ¨ï¼šé †æ¬¡åˆæœŸåŒ–
for rank in range(tensor_parallel_size):
    engine = EngineCore(rank)  # 50 ã‹ã‚‰ 60 ç§’ Ã— 2 = 108 ç§’

# ææ¡ˆï¼šä¸¦åˆ—åˆæœŸåŒ–
with concurrent.futures.ProcessPoolExecutor() as executor:
    futures = [executor.submit(EngineCore, rank) for rank in range(2)]
    engines = [f.result() for f in futures]  # 50 ã‹ã‚‰ 60 ç§’ã®ã¿
```

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€åˆæœŸåŒ–æ™‚é–“ã‚’ 108 ç§’ã‹ã‚‰ 50 ã‹ã‚‰ 60 ç§’ã«å‰Šæ¸›ã§ãã€åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºã«ãŠã„ã¦ 45 ã‹ã‚‰ 50% ã®æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã€‚

**ãƒãƒƒãƒå˜ä½ Logprobs ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**

ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€å„ EngineCoreOutput ã‚’å€‹åˆ¥ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒ N å›ç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ãƒãƒƒãƒå˜ä½ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚

```python
# ç¾åœ¨ï¼šå€‹åˆ¥ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
for output in outputs:
    serialize(output)  # ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ Ã— N

# ææ¡ˆï¼šãƒãƒƒãƒå˜ä½ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
batch_logprobs = concatenate([output.logprobs for output in outputs])
serialize(EngineCoreOutputsBatch(batch_logprobs, request_ids))
```

ã“ã®æœ€é©åŒ–ã«ã‚ˆã‚Šã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå‰Šæ¸›ã•ã‚Œã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã«ãŠã„ã¦ 15 ã‹ã‚‰ 20% ã®æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã€‚

**Lazy CompletionOutput æ§‹ç¯‰**

CompletionOutput ã®æ§‹ç¯‰ã‚’é…å»¶è©•ä¾¡ã«ã™ã‚‹ã“ã¨ã§ã€ä¸è¦ãªå‡¦ç†ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€text ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå®Ÿéš›ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ã¾ã§ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ‡ã‚³ãƒ¼ãƒ‰å‡¦ç†ã‚’é…å»¶ã•ã›ã¾ã™ã€‚

```python
# ææ¡ˆï¼šå¿…è¦ã«ãªã‚‹ã¾ã§é…å»¶ç”Ÿæˆ
class LazyCompletionOutput:
    def __init__(self, core_output):
        self._core_output = core_output
        self._text = None  # é…å»¶è©•ä¾¡

    @property
    def text(self):
        if self._text is None:
            self._text = tokenizer.decode(self._core_output.token_ids)
        return self._text
```

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€ä¸è¦ãªå‡¦ç†ãŒå‰Šæ¸›ã•ã‚Œã€OutputProcessor éƒ¨åˆ†ã«ãŠã„ã¦ 10 ã‹ã‚‰ 15% ã®æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã€‚

### 4.3 é•·æœŸçš„ãªæœ€é©åŒ–ï¼ˆå®Ÿè£…é›£åº¦ï¼šé«˜ï¼‰

é•·æœŸçš„ãªæœ€é©åŒ–ã¨ã—ã¦ã€å®Ÿè£…ã‚³ã‚¹ãƒˆã¯é«˜ã„ã‚‚ã®ã®ã€åŠ‡çš„ãªæ€§èƒ½æ”¹å–„ãŒæœŸå¾…ã§ãã‚‹æ‰‹æ³•ã‚’æ¤œè¨ã—ã¾ã™ã€‚

**Neuron ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°**

Neuron ãƒ¢ãƒ‡ãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«ã¯ 40 ã‹ã‚‰ 50 ç§’ã‹ã‹ã‚Šã¾ã™ãŒã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ã‚°ãƒ©ãƒ•ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ã“ã¨ã§ã€ã“ã®æ™‚é–“ã‚’å¤§å¹…ã«å‰Šæ¸›ã§ãã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ã® NEFF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿å­˜ã—ã€æ¬¡å›èµ·å‹•æ™‚ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã§ã€åˆæœŸåŒ–æ™‚é–“ã‚’ 1 ã‹ã‚‰ 2 ç§’ã«çŸ­ç¸®ã§ãã¾ã™ã€‚

```python
# ææ¡ˆï¼šã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ã‚°ãƒ©ãƒ•ã®æ°¸ç¶šåŒ–
compiled_graph_path = "/tmp/neuron_cache/model.neff"
if os.path.exists(compiled_graph_path):
    model = load_compiled_graph(compiled_graph_path)  # 1 ã‹ã‚‰ 2 ç§’
else:
    model = compile_and_save(model_path, compiled_graph_path)  # 40 ã‹ã‚‰ 50 ç§’
```

ã“ã®æœ€é©åŒ–ã«ã‚ˆã‚Šã€åˆæœŸåŒ–æ™‚é–“ã‚’ 108 ç§’ã‹ã‚‰ 10 ã‹ã‚‰ 20 ç§’ã«å‰Šæ¸›ã§ãã€åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºã«ãŠã„ã¦ 80 ã‹ã‚‰ 90% ã®æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã€‚

**ã‚¨ãƒ³ã‚¸ãƒ³å†åˆ©ç”¨**

åˆæœŸåŒ–æ¸ˆã¿ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ãƒ—ãƒ¼ãƒ«åŒ–ã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã‚„ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã®èµ·å‹•æ™‚é–“ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚ã‚¨ãƒ³ã‚¸ãƒ³ãƒ—ãƒ¼ãƒ«ã‹ã‚‰æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®ã‚¨ãƒ³ã‚¸ãƒ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ã§ã€åˆæœŸåŒ–æ™‚é–“ã‚’ã»ã¼ã‚¼ãƒ­ã«ã§ãã¾ã™ã€‚

```python
# ææ¡ˆï¼šåˆæœŸåŒ–æ¸ˆã¿ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ—ãƒ¼ãƒ«åŒ–
engine_pool = EnginePool(size=3)
engine = engine_pool.get()  # æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
try:
    outputs = engine.generate(prompts)
finally:
    engine_pool.release(engine)
```

ã“ã®æ‰‹æ³•ã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§ã®èµ·å‹•æ™‚é–“ã‚’å‰Šæ¸›ã—ã€åˆæœŸåŒ–ã‚’ã»ã¼ã‚¼ãƒ­ã«ã§ãã¾ã™ã€‚

**ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**

vLLM ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¦ã€ç›´æ¥ NxD Inference (neuronx-distributed-inference) ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’ã»ã¼ã‚¼ãƒ­ã«ã§ãã¾ã™ã€‚

```python
# ç›´æ¥ NxD Inference ã‚’ä½¿ç”¨
import neuronx_distributed_inference as nxdi

model = nxdi.load_model(model_path)
outputs = model.generate(input_ids)  # vLLM ãªã—
```

ã“ã®æœ€é©åŒ–ã«ã‚ˆã‚Šã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒã»ã¼ã‚¼ãƒ­ã«ãªã‚Šã€10 ã‹ã‚‰ 20 å€ã®é«˜é€ŸåŒ–ãŒæœŸå¾…ã§ãã¾ã™ã€‚ãŸã ã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¨ã—ã¦ã€vLLM ã®æ©Ÿèƒ½ï¼ˆå‹•çš„ãƒãƒƒãƒãƒ³ã‚°ã€KV ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ï¼‰ã‚’å¤±ã†ã“ã¨ã«ãªã‚Šã€é–‹ç™ºã‚³ã‚¹ãƒˆãŒéå¸¸ã«é«˜ããªã‚Šã¾ã™ã€‚

## Phase 5: vLLM ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£çš„åˆ¶ç´„

### 5.1 ãªãœã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå¤§ãã„ã®ã‹

vLLM ãŒ 95% ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’æŒã¤ç†ç”±ã¯ã€ãã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«èµ·å› ã—ã¾ã™ã€‚

**vLLM v1 ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒãƒ«ãƒãƒ—ãƒ­ã‚»ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

vLLM v1 ã‚¨ãƒ³ã‚¸ãƒ³ã¯ã€API Serverã€EngineCore Processã€Neuron Worker Processã€NeuronCore ã¨ã„ã†éšå±¤æ§‹é€ ã‚’æŒã£ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€API Server (Python) ã‹ã‚‰ ZMQ PUSH ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã€EngineCore Process (Ray) ã§ ZMQ PULL ã«ã‚ˆã‚Šçµæœã‚’å—ä¿¡ã—ã¾ã™ã€‚EngineCore Process å†…ã«ã¯ã€Schedulerï¼ˆãƒãƒƒãƒãƒ³ã‚°ã€KV ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ï¼‰ã€OutputProcessorï¼ˆçµæœã®å¾Œå‡¦ç†ï¼‰ã€ModelExecutor ãŒå«ã¾ã‚Œã¾ã™ã€‚ModelExecutor ã‹ã‚‰ã¯ Neuron Worker Process ã‚’çµŒç”±ã—ã¦ã€æœ€çµ‚çš„ã« NeuronCore ã§å®Ÿéš›ã®è¨ˆç®—ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

ã“ã®æ§‹é€ ã«ã‚ˆã‚Šã€å„ã‚¹ãƒ†ãƒƒãƒ—ã§è¤‡æ•°ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã¾ãšã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€Python ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ MessagePack ã¸ã®å¤‰æ›ãŒè¡Œã‚ã‚Œã¾ã™ã€‚æ¬¡ã«ã€ZMQ é€ä¿¡ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ãŒç™ºç”Ÿã—ã¾ã™ã€‚ãã®å¾Œã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€EngineCoreOutput ã‹ã‚‰ MessagePack ã¸ã®å¤‰æ›ãŒè¡Œã‚ã‚Œã€ZMQ å—ä¿¡ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ãŒç™ºç”Ÿã—ã¾ã™ã€‚æœ€å¾Œã«ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ MessagePack ã‹ã‚‰ Python ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®å¤‰æ›ãŒè¡Œã‚ã‚Œã€OutputProcessor ã«ã‚ˆã‚Š RequestOutput ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã‚‰ã®å‡¦ç†ã¯ vLLM ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ãŠã„ã¦å¿…é ˆã§ã‚ã‚Šã€è¨­å®šã§ã¯å‰Šæ¸›ã§ãã¾ã›ã‚“ã€‚

### 5.2 vLLM ã®è¨­è¨ˆæ€æƒ³

vLLM ãŒã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ç†ç”±ã¯ã€ãã®è¨­è¨ˆæ€æƒ³ã«ã‚ã‚Šã¾ã™ã€‚

ç¬¬ä¸€ã«ã€æ±ç”¨æ€§ã‚’é‡è¦–ã—ã¦ã„ã¾ã™ã€‚vLLM ã¯ã€ã‚ã‚‰ã‚†ã‚‹ãƒ¢ãƒ‡ãƒ«ï¼ˆLLMã€VLMã€Embeddingï¼‰ã«å¯¾å¿œã—ã€è¤‡æ•°ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆCUDAã€ROCmã€Neuronï¼‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

ç¬¬äºŒã«ã€æŸ”è»Ÿæ€§ã‚’æä¾›ã—ã¾ã™ã€‚å‹•çš„ãƒãƒƒãƒãƒ³ã‚°ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‹•çš„ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰ã€ãƒ—ãƒªã‚¨ãƒ³ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå„ªå…ˆåº¦ã«åŸºã¥ãã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼‰ã€KV ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åŠ¹ç‡çš„ãªç®¡ç†ãªã©ã®æ©Ÿèƒ½ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

ç¬¬ä¸‰ã«ã€æ‹¡å¼µæ€§ã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™ã€‚ãƒ†ãƒ³ã‚½ãƒ«ä¸¦åˆ—ï¼ˆtensor_parallel_sizeï¼‰ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä¸¦åˆ—ï¼ˆpipeline_parallel_sizeï¼‰ã€ãƒ‡ãƒ¼ã‚¿ä¸¦åˆ—ï¼ˆdata_parallel_sizeï¼‰ã¨ã„ã£ãŸã€å¤§è¦æ¨¡ãªåˆ†æ•£æ¨è«–ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯è¨­è¨ˆä¸Šã®å¿…ç„¶ã§ã‚ã‚Šã€é¿ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

### 5.3 ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã®æ¯”è¼ƒ

3 ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¯”è¼ƒã™ã‚‹ã¨ã€ãã‚Œãã‚Œç•°ãªã‚‹ç‰¹æ€§ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

vLLM ã¯ã€æ€§èƒ½ãŒâ˜…â˜…â˜…ã€æŸ”è»Ÿæ€§ãŒâ˜…â˜…â˜…â˜…â˜…ã€é–‹ç™ºã‚³ã‚¹ãƒˆãŒâ˜…ã§ã€æ±ç”¨çš„ãª LLM ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã«é©ã—ã¦ã„ã¾ã™ã€‚ç›´æ¥ AWS Neuron SDK ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€æ€§èƒ½ãŒâ˜…â˜…â˜…â˜…â˜…ã€æŸ”è»Ÿæ€§ãŒâ˜…ã€é–‹ç™ºã‚³ã‚¹ãƒˆãŒâ˜…â˜…â˜…â˜…â˜…ã§ã€å˜ä¸€ãƒ¢ãƒ‡ãƒ«ã‚„å›ºå®šãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã«é©ã—ã¦ã„ã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…ã¯ã€æ€§èƒ½ãŒâ˜…â˜…â˜…â˜…ã€æŸ”è»Ÿæ€§ãŒâ˜…â˜…ã€é–‹ç™ºã‚³ã‚¹ãƒˆãŒâ˜…â˜…â˜…â˜…ã§ã€ç‰¹å®šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«æœ€é©åŒ–ã•ã‚ŒãŸå®Ÿè£…ã«é©ã—ã¦ã„ã¾ã™ã€‚

vLLM ã¯ã€Œæ±ç”¨æ€§ã€ã‚’æœ€å„ªå…ˆã—ã€ã€Œæ€§èƒ½ã€ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã—ã¦ã„ã‚‹ã¨ã„ã†è¨­è¨ˆæ–¹é‡ãŒæ˜ç¢ºã§ã™ã€‚

### 5.4 æ ¹æœ¬çš„ãªå•é¡Œï¼šè¨­å®šã§ã¯è§£æ±ºä¸å¯

ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœã‹ã‚‰ã€è¨­å®šã«ã‚ˆã‚‹æœ€é©åŒ–ã®é™ç•ŒãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã—ãŸã€‚

è¨­å®šã§å‰Šæ¸›å¯èƒ½ãªã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯ã€ã‚ãšã‹ 3 ã‹ã‚‰ 5 msï¼ˆ2 ã‹ã‚‰ 4%ï¼‰ã«éãã¾ã›ã‚“ã€‚ãã®å†…è¨³ã¯ã€ãƒ­ã‚°å‡ºåŠ›ãŒ 1 ã‹ã‚‰ 2 msã€tqdm ãŒ 1 ã‹ã‚‰ 2 msã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®å¾®èª¿æ•´ãŒ 1 ã‹ã‚‰ 2 ms ã§ã™ã€‚

ä¸€æ–¹ã€è¨­å®šã§å‰Šæ¸›ä¸å¯èƒ½ãªã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯ã€ç´„ 120 msï¼ˆ95%ï¼‰ã«ã‚‚é”ã—ã¾ã™ã€‚ãã®å†…è¨³ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãŒ 66 msï¼ˆ52%ï¼‰ã€ãƒ‡ãƒ¼ã‚¿è»¢é€ãŒ 41 msï¼ˆ32%ï¼‰ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãŒ 8 msï¼ˆ6%ï¼‰ã€ãã®ä»–ãŒ 5 msï¼ˆ4%ï¼‰ã§ã™ã€‚

ã“ã®çµæœã‹ã‚‰ã€è¨­å®šæœ€é©åŒ–ã§ã¯ã»ã¨ã‚“ã©æ”¹å–„ã—ãªã„ã¨ã„ã†çµè«–ã«è‡³ã‚Šã¾ã™ã€‚

## Phase 6: æœ€é©åŒ–ã®å„ªå…ˆé †ä½

### 6.1 åŠ¹æœã®å¤§ãã„é †ã«æ•´ç†

ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœã‹ã‚‰ã€æœ€é©åŒ–ã®å„ªå…ˆé †ä½ã‚’æ•´ç†ã—ã¾ã™ã€‚

**Tier 1ï¼šã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¤‰æ›´ï¼ˆæ½œåœ¨çš„ã« 10 ã‹ã‚‰ 20 å€ã®é«˜é€ŸåŒ–ï¼‰**

æœ€ã‚‚åŠ¹æœãŒå¤§ãã„ã®ã¯ã€vLLM ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¦ç›´æ¥ AWS Neuron SDK ã‚’ä½¿ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚å…·ä½“çš„ã«ã¯ã€neuronx-distributed-inference (NxD Inference) ã‚’ç›´æ¥ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€vLLM ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å®Œå…¨ã«å›é¿ã§ãã¾ã™ã€‚

```python
import neuronx_distributed_inference as nxdi

# vLLM ã‚’ä½¿ã‚ãšã€ç›´æ¥ NxD Inference ã‚’ä½¿ç”¨
model = nxdi.load_model(model_path)
outputs = model.generate(input_ids)
```

ã“ã®æ‰‹æ³•ã«ã‚ˆã‚Šã€126 ms ã‹ã‚‰ 10 ã‹ã‚‰ 15 ms ã¸ã®çŸ­ç¸®ï¼ˆç´„ 10 å€ã®é«˜é€ŸåŒ–ï¼‰ãŒæœŸå¾…ã§ãã¾ã™ã€‚ãŸã ã—ã€ãƒªã‚¹ã‚¯ã¯éå¸¸ã«é«˜ãã€å‹•çš„ãƒãƒƒãƒãƒ³ã‚°ã®å–ªå¤±ã€KV ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã®è‡ªå‰å®Ÿè£…ã€vLLM ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®é›¢è„±ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€å·¥æ•°ã‚‚éå¸¸ã«å¤§ããã€3 ã‹ã‚‰ 6 ãƒ¶æœˆã®é–‹ç™ºæœŸé–“ãŒå¿…è¦ã§ã™ã€‚

**Tier 2ï¼šãƒãƒƒãƒã‚µã‚¤ã‚ºå¢—åŠ ï¼ˆ10 ã‹ã‚‰ 15% ã®æ”¹å–„ï¼‰**

æ¯”è¼ƒçš„ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹æœ€é©åŒ–ã¨ã—ã¦ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºã®å¢—åŠ ãŒã‚ã‚Šã¾ã™ã€‚config.yaml ã§ batch_size ã‚’ 4 ã‹ã‚‰ 8 ã¾ãŸã¯ 16 ã«ã€max_num_seqs ã‚’ 4 ã‹ã‚‰ 8 ã¾ãŸã¯ 16 ã«å¢—ã‚„ã™ã“ã¨ã§ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å„Ÿå´ã§ãã¾ã™ã€‚

```yaml
# config.yaml
reranker:
  batch_size: 8  # 4 â†’ 8 or 16
vllm:
  max_num_seqs: 8  # 4 â†’ 8 or 16
```

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€126 ms ã‹ã‚‰ 107 ã‹ã‚‰ 113 ms ã¸ã®çŸ­ç¸®ï¼ˆ10 ã‹ã‚‰ 15% ã®æ”¹å–„ï¼‰ãŒæœŸå¾…ã§ãã¾ã™ã€‚ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¨ã—ã¦ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã®å¢—åŠ ãŒã‚ã‚Šã¾ã™ãŒã€å·¥æ•°ã¯éå¸¸ã«å°ã•ãã€1 æ™‚é–“ç¨‹åº¦ã§å®Ÿè£…ã§ãã¾ã™ã€‚

**Tier 3ï¼šæ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆç·šå½¢ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã€æœ€ã‚‚ç¾å®Ÿçš„ï¼‰**

æœ€ã‚‚ç¾å®Ÿçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã§ã™ã€‚Application Load Balancer (ALB) ã‚’ä½¿ç”¨ã—ã¦ã€è¤‡æ•°ã® inf2.xlarge ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«è² è·ã‚’åˆ†æ•£ã™ã‚‹ã“ã¨ã§ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’ç·šå½¢ã«å¢—ã‚„ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®æ‰‹æ³•ã«ã‚ˆã‚Šã€3.24 QPS ã‹ã‚‰ 6.48 QPSï¼ˆ2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å ´åˆï¼‰ã¸ã®æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã€‚ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€å†—é•·æ€§ãƒ»å¯ç”¨æ€§ã®ç¢ºä¿ã¨å®Ÿè£…ã®å®¹æ˜“ã•ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚å·¥æ•°ã¯å°ã•ãã€1 ã‹ã‚‰ 2 æ—¥ç¨‹åº¦ã§å®Ÿè£…ã§ãã¾ã™ã€‚

**Tier 4ï¼šè¨­å®šãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆ1 ã‹ã‚‰ 2%ã€ã»ã¼åŠ¹æœãªã—ï¼‰**

æœ€ã‚‚åŠ¹æœãŒå°ã•ã„ã®ã¯ã€è¨­å®šãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã™ã€‚ãƒ­ã‚°ç„¡åŠ¹åŒ–ã€tqdm ç„¡åŠ¹åŒ–ã€Zero-copy threshold èª¿æ•´ãªã©ãŒè©²å½“ã—ã¾ã™ãŒã€æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„ã¯ 1 ã‹ã‚‰ 2% ã«éãã¾ã›ã‚“ã€‚å·¥æ•°ã¯éå¸¸ã«å°ã•ãã€30 åˆ†ç¨‹åº¦ã§å®Ÿè£…ã§ãã¾ã™ãŒã€åŠ¹æœã¯ã»ã¨ã‚“ã©æœŸå¾…ã§ãã¾ã›ã‚“ã€‚

### 6.2 æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¿œã˜ã¦ã€3 ã¤ã®ã‚·ãƒŠãƒªã‚ªã‚’ææ¡ˆã—ã¾ã™ã€‚

#### ã‚·ãƒŠãƒªã‚ª 1ï¼šæœ¬ç•ªç’°å¢ƒï¼ˆæ¨å¥¨ï¼‰

æœ¬ç•ªç’°å¢ƒã§ã¯ã€æ€§èƒ½è¦ä»¶ã¨ã—ã¦ 3 ã‹ã‚‰ 4 QPSã€ç´„ 300 ms ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹å ´åˆã€æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒæœ€é©ãªè§£æ±ºç­–ã§ã™ã€‚

æ§‹æˆã¨ã—ã¦ã¯ã€2 ã‹ã‚‰ 3 å€‹ã® inf2.xlarge ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ Application Load Balancer ã®èƒŒå¾Œã«é…ç½®ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åˆè¨ˆ 6 ã‹ã‚‰ 12 QPS ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒå¾—ã‚‰ã‚Œã€å†—é•·æ€§ãƒ»å¯ç”¨æ€§ã‚‚ç¢ºä¿ã§ãã¾ã™ã€‚

å®Ÿè£…ã¯ã€Terraform ã‚„ AWS CloudFormation ã‚’ä½¿ç”¨ã—ã¦æ§‹æˆã—ã¾ã™ã€‚

```bash
# Terraform / CloudFormation ã§æ§‹æˆ
resource "aws_lb_target_group" "vllm" {
  name     = "vllm-reranker"
  port     = 8000
  protocol = "HTTP"
  target_type = "instance"

  health_check {
    path = "/health"
  }
}
```

#### ã‚·ãƒŠãƒªã‚ª 2ï¼šç ”ç©¶ãƒ»PoC

ç ”ç©¶ã‚„ PoC ã®ç›®çš„ã§æœ€å¤§æ€§èƒ½ã‚’è¿½æ±‚ã™ã‚‹å ´åˆã€ç›´æ¥ AWS Neuron SDK ã¨ã®æ¯”è¼ƒå®Ÿé¨“ã‚’è¡Œã„ã¾ã™ã€‚

```python
# ç›´æ¥ Neuron SDK ã¨ã®æ¯”è¼ƒå®Ÿé¨“
import neuronx_distributed_inference as nxdi

# æœŸå¾…ã•ã‚Œã‚‹æ€§èƒ½ï¼š
# - vLLMï¼š126 ms per batch (7.9 batches/s)
# - Direct SDKï¼š10 ã‹ã‚‰ 15 ms per batch (66 ã‹ã‚‰ 100 batches/s)
# - æ”¹å–„ç‡ï¼š8 ã‹ã‚‰ 12 å€

# âš ï¸ å¤±ã†ã‚‚ã®ï¼š
# - å‹•çš„ãƒãƒƒãƒãƒ³ã‚°
# - é€£ç¶šãƒãƒƒãƒãƒ³ã‚°
# - KV ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
# - vLLM ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ 
```

é–‹ç™ºå·¥æ•°ã¨ã—ã¦ã€PoC ã«ã¯ 1 ã‹ã‚‰ 2 é€±é–“ã€æœ¬ç•ªåŒ–ã«ã¯ 3 ã‹ã‚‰ 6 ãƒ¶æœˆãŒå¿…è¦ã§ã™ã€‚

#### ã‚·ãƒŠãƒªã‚ª 3ï¼šãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰

ã‚·ãƒ³ãƒ—ãƒ«ãªã‚±ãƒ¼ã‚¹ã¨ã«ã¯ç›´æ¥ SDK ã‚’ä½¿ç”¨ã—ã€è¤‡é›‘ãªã‚±ãƒ¼ã‚¹ã«ã¯ vLLM ã‚’ä½¿ç”¨ã™ã‚‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚‚æ¤œè¨ã§ãã¾ã™ã€‚

```python
# ã‚·ãƒ³ãƒ—ãƒ«ãªã‚±ãƒ¼ã‚¹ï¼šç›´æ¥ SDK
if request.is_simple_reranking() and batch_size >= 16:
    return neuron_sdk.inference(request)

# è¤‡é›‘ãªã‚±ãƒ¼ã‚¹ï¼švLLM
else:
    return vllm.generate(request)
```

ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€ä¸¡æ–¹ã®åˆ©ç‚¹ã‚’äº«å—ã§ãã€ãƒªã‚¹ã‚¯ã‚’åˆ†æ•£ã§ãã¾ã™ã€‚ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€è¤‡é›‘æ€§ã®å¢—åŠ ã¨ã€2 ã¤ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¿å®ˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## æœ€çµ‚è€ƒå¯Ÿ: é‡è¦ãªæ•™è¨“

### 1. ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã®ä½¿ã„åˆ†ã‘

ä»Šå›ã®èª¿æŸ»ã§ã€è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã®é‡è¦æ€§ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã—ãŸã€‚

| ãƒ„ãƒ¼ãƒ« | æ¸¬å®šç¯„å›² | åˆ©ç‚¹ | åˆ¶é™ |
|--------|---------|------|------|
| **Neuron Profiler** | Neuron ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ | ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã®è©³ç´°ãªå‹•ä½œ | Python/vLLM ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯æ¸¬å®šä¸å¯ |
| **line_profiler** | Python ã‚³ãƒ¼ãƒ‰ | è¡Œå˜ä½ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®š | C/C++ æ‹¡å¼µã¯æ¸¬å®šä¸å¯ |
| **vLLM å†…éƒ¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°** | vLLM ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | é–¢æ•°ãƒ¬ãƒ™ãƒ«ã®æ™‚é–“è¨ˆæ¸¬ | è©³ç´°ãªå†…éƒ¨å‹•ä½œã®ç†è§£ãŒå¿…è¦ |
| **ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯** | ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ | å®Ÿç’°å¢ƒã«è¿‘ã„çµæœ | ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®ç†ç”±ã¯åˆ†ã‹ã‚‰ãªã„ |

**æ•™è¨“**: å˜ä¸€ã®ãƒ„ãƒ¼ãƒ«ã§ã¯å…¨ä½“åƒã¯è¦‹ãˆãªã„ã€‚è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ã‚’çµ„ã¿åˆã‚ã›ã¦ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«åˆ†æã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

### 2. ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒé€Ÿãã¦ã‚‚æ„å‘³ãŒãªã„

ä»Šå›ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã§æœ€ã‚‚è¡æ’ƒçš„ã ã£ãŸç™ºè¦‹:

```
Neuron è¨ˆç®—: 6ms (4.8%)    â† è¶…é«˜é€Ÿ
å…¨ä½“:       126ms (100%)   â† 20å€ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
```

**æ•™è¨“**: ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¯ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã§ã¯ãªããƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚

é¡ä¼¼ä¾‹:
- GPU ãŒé€Ÿãã¦ã‚‚ã€ãƒ‡ãƒ¼ã‚¿è»¢é€ãŒé…ã‘ã‚Œã°æ„å‘³ãŒãªã„
- SSD ãŒé€Ÿãã¦ã‚‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒé…ã‘ã‚Œã°æ„å‘³ãŒãªã„
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé€Ÿãã¦ã‚‚ã€TCP/IP ã‚¹ã‚¿ãƒƒã‚¯ãŒé…ã‘ã‚Œã°æ„å‘³ãŒãªã„

**ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æœ€é©åŒ–** ãŒä¸å¯æ¬ ã§ã™ã€‚

### 3. æ±ç”¨æ€§ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•

vLLM ãŒ 95% ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’æŒã¤ç†ç”±ã¯ã€å‹•çš„ãƒãƒƒãƒãƒ³ã‚°ã€ãƒ—ãƒªã‚¨ãƒ³ãƒ—ã‚·ãƒ§ãƒ³ã€è¤‡æ•°ãƒ¢ãƒ‡ãƒ«å¯¾å¿œã€åˆ†æ•£æ¨è«–ï¼ˆTPã€PPã€DPï¼‰ã€æŸ”è»Ÿãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã¨ã„ã£ãŸæ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã§ã™ã€‚ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯è¨­è¨ˆä¸Šã®å¿…ç„¶ã§ã™ã€‚

ã“ã®ã“ã¨ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹æ•™è¨“ã¯ã€æ±ç”¨çš„ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ç‰¹å®šã®ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã«ã¯æœ€é©ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¿œã˜ã¦é©åˆ‡ãªãƒ„ãƒ¼ãƒ«ã‚’é¸ã¶å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚

### 4. æ¸¬å®šã§ããªã„ã‚‚ã®ã¯æ”¹å–„ã§ããªã„

ä»Šå›ã®èª¿æŸ»ã§ã€ç›´æ„Ÿçš„ã«ã¯ã€Œé€Ÿããªã‚‹ã¯ãšã€ã¨æ€ã‚ã‚ŒãŸæœ€é©åŒ–ãŒå®Ÿéš›ã«ã¯åŠ¹æœãŒãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚å…·ä½“çš„ã«ã¯ã€skip_warmup=False ã¯ 4% é…ããªã‚Šã€ãƒ­ã‚°ç„¡åŠ¹åŒ–ã¯ 0.9% ã®æ”¹å–„ã®ã¿ã€ãƒãƒƒãƒãƒ³ã‚°æ”¹å–„ã¯ 1.1% ã®æ”¹å–„ã®ã¿ã§ã—ãŸã€‚

é€†ã«ã€æ¸¬å®šã«ã‚ˆã£ã¦æ˜ã‚‰ã‹ã«ãªã£ãŸã“ã¨ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãŒ 52% ã‚’å ã‚ã‚‹ã“ã¨ã€Neuron è¨ˆç®—ã¯ 5% ã®ã¿ã§ã‚ã‚‹ã“ã¨ã€è¨­å®šã§ã¯æ”¹å–„ã—ãªã„ã“ã¨ã§ã™ã€‚

ã“ã®ã“ã¨ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹æ•™è¨“ã¯ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæœ€é©åŒ–ãŒä¸å¯æ¬ ã§ã‚ã‚Šã€ç›´æ„Ÿã§ã¯ãªãæ¸¬å®šçµæœã«åŸºã¥ã„ã¦åˆ¤æ–­ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚

## çµè«–

### ä»Šå›åˆ†ã‹ã£ãŸã“ã¨

ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœã‹ã‚‰ã€3 ã¤ã®é‡è¦ãªç™ºè¦‹ãŒã‚ã‚Šã¾ã—ãŸã€‚

ç¬¬ä¸€ã«ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®ç‰¹å®šãŒã§ãã¾ã—ãŸã€‚AWS Neuron ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¯ 6 msï¼ˆ4.8%ï¼‰ã§ã‚ã‚Šã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸€æ–¹ã€vLLM ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ 117 msï¼ˆ92.9%ï¼‰ã§ã‚ã‚Šã€çœŸã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã§ã™ã€‚ãã®å†…è¨³ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãŒ 66 msï¼ˆ52.4%ï¼‰ã€ãƒ‡ãƒ¼ã‚¿è»¢é€ãŒ 41 msï¼ˆ32.5%ï¼‰ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãŒ 8 msï¼ˆ6.3%ï¼‰ã§ã™ã€‚

ç¬¬äºŒã«ã€åˆæœŸåŒ–ã®å†…è¨³ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã—ãŸã€‚ç·åˆæœŸåŒ–æ™‚é–“ã¯ 120 ç§’ã§ã€ãã®å¤§éƒ¨åˆ†ã¯ EngineCoreClient.make_client() ãŒå ã‚ã‚‹ 108 ç§’ï¼ˆ90%ï¼‰ã§ã™ã€‚ã•ã‚‰ã«è©³ã—ãè¦‹ã‚‹ã¨ã€AWS Neuron ãƒ¢ãƒ‡ãƒ«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒ 40 ã‹ã‚‰ 50 ç§’ã€KV ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆæœŸåŒ–ãŒ 10 ã‹ã‚‰ 15 ç§’ã€ãƒ¢ãƒ‡ãƒ«ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ãŒ 15 ã‹ã‚‰ 20 ç§’ã€ZMQ ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ãŒ 10 ã‹ã‚‰ 15 ç§’ã¨ãªã£ã¦ã„ã¾ã™ã€‚

ç¬¬ä¸‰ã«ã€æœ€é©åŒ–ã®å¯èƒ½æ€§ãŒæ˜ç¢ºã«ãªã‚Šã¾ã—ãŸã€‚è¨­å®šãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã¯ 1 ã‹ã‚‰ 2% ã®æ”¹å–„ã®ã¿ã§ã™ãŒã€ãƒãƒƒãƒã‚µã‚¤ã‚ºå¢—åŠ ã¯ 10 ã‹ã‚‰ 15% ã®æ”¹å–„ã€ä¸¦åˆ—åˆæœŸåŒ–ã¯ 50% ã®åˆæœŸåŒ–æ™‚é–“å‰Šæ¸›ã€ç›´æ¥ AWS Neuron SDK ã®ä½¿ç”¨ã¯ 10 ã‹ã‚‰ 20 å€ã®é«˜é€ŸåŒ–ãŒæœŸå¾…ã§ãã¾ã™ï¼ˆãŸã ã—é–‹ç™ºã‚³ã‚¹ãƒˆã¯å¤§ãã„ï¼‰ã€‚

### ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®å…¨ä½“åƒ

ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¯ã€åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºã¨æ¨è«–ãƒ•ã‚§ãƒ¼ã‚ºã«åˆ†ã‘ã¦æ•´ç†ã§ãã¾ã™ã€‚

åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ120 ç§’ã€1 å›ã®ã¿ï¼‰ã§ã¯ã€AWS Neuron ãƒ¢ãƒ‡ãƒ«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒ 40 ã‹ã‚‰ 50 ç§’ï¼ˆ37 ã‹ã‚‰ 46%ï¼‰ã€KV ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆæœŸåŒ–ãŒ 10 ã‹ã‚‰ 15 ç§’ï¼ˆ9 ã‹ã‚‰ 14%ï¼‰ã€ãƒ¢ãƒ‡ãƒ«ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ãŒ 15 ã‹ã‚‰ 20 ç§’ï¼ˆ14 ã‹ã‚‰ 18%ï¼‰ã€ZMQ ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ãŒ 10 ã‹ã‚‰ 15 ç§’ï¼ˆ9 ã‹ã‚‰ 14%ï¼‰ã¨ãªã£ã¦ã„ã¾ã™ã€‚

æ¨è«–ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ126 ms ãƒãƒƒãƒã€ç¹°ã‚Šè¿”ã—ï¼‰ã§ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãŒ 66 msï¼ˆ52.4%ï¼‰ã€ãƒ‡ãƒ¼ã‚¿è»¢é€ï¼ˆRay IPCï¼‰ãŒ 41 msï¼ˆ32.5%ï¼‰ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãŒ 8 msï¼ˆ6.3%ï¼‰ã€AWS Neuron è¨ˆç®—ãŒ 6 msï¼ˆ4.8%ï¼‰ã€ãã®ä»–ãŒ 5 msï¼ˆ4.0%ï¼‰ã¨ãªã£ã¦ã„ã¾ã™ã€‚

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ä»Šå¾Œã®å–ã‚Šçµ„ã¿ã‚’ã€çŸ­æœŸã€ä¸­æœŸã€é•·æœŸã«åˆ†ã‘ã¦æ•´ç†ã—ã¾ã™ã€‚

çŸ­æœŸï¼ˆ1 ã‹ã‚‰ 2 é€±é–“ï¼‰ã§ã¯ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆã€æœ¬ç•ªç’°å¢ƒã§ã®è² è·ãƒ†ã‚¹ãƒˆã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šãŒå¿…è¦ã§ã™ã€‚

ä¸­æœŸï¼ˆ1 ã‹ã‚‰ 2 ãƒ¶æœˆï¼‰ã§ã¯ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºå¢—åŠ ã®åŠ¹æœæ¤œè¨¼ã€ä¸¦åˆ—åˆæœŸåŒ–ã®å®Ÿè£… PoCã€ç›´æ¥ AWS Neuron SDK ã¨ã®æ¯”è¼ƒ PoCã€ã‚³ã‚¹ãƒˆãƒ»æ€§èƒ½ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•åˆ†æã‚’è¡Œã„ã¾ã™ã€‚

é•·æœŸï¼ˆ3 ã‹ã‚‰ 6 ãƒ¶æœˆï¼‰ã§ã¯ã€ã‚«ã‚¹ã‚¿ãƒ æ¨è«–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€vLLM ã¸ã®è²¢çŒ®ï¼ˆAWS Neuron æœ€é©åŒ–ï¼‰ã€ä»–ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆTGIã€LMDeployï¼‰ã®è©•ä¾¡ã€AWS Neuron ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã®å®Ÿè£…ã‚’æ¤œè¨ã—ã¾ã™ã€‚

### æœ€å¾Œã«

æ€§èƒ½æœ€é©åŒ–ã¯ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸç§‘å­¦çš„ãªãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚

```
1. æ¸¬å®š (è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ã§å¤šè§’çš„ã«)
     â†“
2. åˆ†æ (ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®å ´æ‰€ã¨ç†ç”±)
     â†“
3. ä»®èª¬ (ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæœ€é©åŒ–æˆ¦ç•¥)
     â†“
4. å®Ÿé¨“ (åŠ¹æœã‚’å®šé‡çš„ã«æ¤œè¨¼)
     â†“
5. åå¾© (ç¶™ç¶šçš„ãªæ”¹å–„)
```

ä»Šå›ã®èª¿æŸ»ã§ã€ç›´æ„Ÿçš„ã«ã¯ã€Œé€Ÿããªã‚‹ã¯ãšã€ã¨æ€ã‚ã‚ŒãŸæœ€é©åŒ–ãŒå®Ÿéš›ã«ã¯åŠ¹æœãŒãªãã€é€†ã« vLLM ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£çš„ãªåˆ¶ç´„ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã—ãŸã€‚

**ã€Œæ¸¬å®šã§ããªã„ã‚‚ã®ã¯æ”¹å–„ã§ããªã„ã€**

ã“ã®æ•™è¨“ã‚’èƒ¸ã«ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [AWS Neuron Profiler 2.0](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/tools/neuron-sys-tools/neuron-profile-user-guide.html) - Neuron Profiler ã®ä½¿ã„æ–¹ã¨è§£ææ–¹æ³•
- [Perfetto Trace Processor](https://perfetto.dev/docs/analysis/trace-processor-python) - Python ã‚’ä½¿ã£ãŸãƒˆãƒ¬ãƒ¼ã‚¹åˆ†æã®æ–¹æ³•
- [vLLM Documentation](https://docs.vllm.ai/) - vLLM ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¨è¨­å®šæ–¹æ³•
- [line_profiler](https://github.com/pyutils/line_profiler) - line_profiler ã®è©³ç´°ãªä½¿ã„æ–¹
- [AWS Neuron Custom Operators](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/neuron-customops/index.html) - ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã®å®Ÿè£…æ–¹æ³•
- [vLLM-Neuron Quickstart](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/libraries/nxd-inference/vllm/quickstart-vllm-offline-serving.html) - vLLM-Neuron ã®è¨­å®šã¨ skip_warmup ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- [Unlocking ML Performance](https://builder.aws.com/content/2x3ldAuia9gjjUixpOt162ttkK2/unlocking-machine-learning-model-performance-from-bottlenecks-to-breakthroughs) - AWS ã«ã‚ˆã‚‹æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®æ€§èƒ½æœ€é©åŒ–ã®å®Ÿè·µçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

---

## ä»˜éŒ²: å®Œå…¨ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿

ã™ã¹ã¦ã®å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã¨è©³ç´°ãªåˆ†æã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

**è©³ç´°ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆ**: [`/home/coder/vllm_bottleneck_analysis.md`](/home/coder/vllm_bottleneck_analysis.md)

ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã«ã¯ã€åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºã®è©³ç´°åˆ†æï¼ˆ120.5 ç§’ï¼‰ã€æ¨è«–ãƒ•ã‚§ãƒ¼ã‚ºã®è©³ç´°åˆ†æï¼ˆ126 ms ãƒãƒƒãƒï¼‰ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®è©³ç´°ã€vLLM ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰èª¿æŸ»çµæœã€æœ€é©åŒ–ã®æ¨å¥¨äº‹é …ï¼ˆçŸ­æœŸãƒ»ä¸­æœŸãƒ»é•·æœŸï¼‰ã€ã‚³ãƒ¼ãƒ‰å‚ç…§ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒå«ã¾ã‚Œã¾ã™ã€‚
