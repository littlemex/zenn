---
title: "Amazon EC2 Capacity Block for ML ã‚’ä½¿ã£ã¦ AWS Trainium ç³»ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã™ã‚‹"
emoji: "ğŸš€"
type: "tech"
topics: ["aws", "cdk", "trainium", "neuron", "ml"]
published: true
---

## ã¯ã˜ã‚ã«

ä»¥å‰ã€[AWS Trainium ã§ Code Server ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹è¨˜äº‹](https://zenn.dev/tosshi/articles/eb54037328d2ef)ã‚’å…¬é–‹ã—ã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã§ã¯ AWS CloudFormation ã‚’ç”¨ã„ã¦æ¤œè¨¼ç’°å¢ƒã‚’ Amazon EC2 ã§æ§‹ç¯‰ã—ã€ Code Server ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦æ¤œè¨¼ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚‚ã®ã§ã—ãŸã€‚æœ¬è¨˜äº‹ã§ã¯ã€Amazon EC2 Capacity Block for ML ã‚’ä½¿ç”¨ã—ã¦ã€AWS CDK ã§ `trn2.3xlarge` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã€Code Server ã§æ¤œè¨¼ã§ãã‚‹ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

å‰å›ã®è¨˜äº‹ã® User Data ã«ã‚ˆã‚‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã¯ OS/CPU ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å¤‰ãˆã‚‹ãŸã³ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«å‹•ãã‹ä½•åº¦ã‚‚ CloudFormationã®è¨­å®šã‚’å¤‰ãˆã¦ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ç¢ºèªã—ã¦ãŠã‚Šã€æ•°æ™‚é–“ã‚’æº¶ã‹ã—ã¦ã„ã¾ã—ãŸã€‚ã“ã®å€‹äººçš„ã«è¾›ã„èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€CDK ã§ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®èµ·å‹•ã¾ã§ã‚’è¡Œã„ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æµã—è¾¼ã¿ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•å¾Œã«ãƒ­ãƒ¼ã‚«ãƒ«ç«¯æœ«ã‹ã‚‰ AWS Systems Manager Run Command ã‚’ä½¿ã£ã¦å†ªç­‰ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å¤±æ•—ã—ãŸç®‡æ‰€ã‹ã‚‰å†é–‹å¯èƒ½ã§å€‹äººçš„ãªè¾›ã¿ãŒæ¸›ã‚Šã¾ã™ã€‚

:::message
æœ¬è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰å…¨ä½“ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚
https://github.com/littlemex/ec2-cfn-templates-for-genai/tree/main/samples/aws-neuron/torch-neuronx/multi-framework-dlami-ubuntu24-cdk
:::

## Amazon EC2 Capacity Block for ML ã¨ã¯

Amazon EC2 Capacity Block for ML ã¯ã€ç‰¹å®šã®æœŸé–“ï¼ˆä¾‹ï¼š24 æ™‚é–“ï¼‰ã ã‘æ©Ÿæ¢°å­¦ç¿’å‘ã‘ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆAWS Trainium ã‚„ AWS Inferentia ãªã©ï¼‰ã‚’äºˆç´„è³¼å…¥ã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã‚ˆã‚Šã‚‚å®‰ä¾¡ã« GPU ã‚„ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚¿ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚åŸ·ç­†æ™‚ç‚¹ã ã¨ã€`p6-b200`, `p5`, `p5e`, `p5en`, `p4d`, `p4de`, `trn1`, and `trn2` ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚åŸºæœ¬çš„ã« GPU ãŒä¹—ã£ãŸå¤§ããªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã“ã® Capacity Block ã‚’ä½¿ã£ãŸã“ã¨ãŒãªã„æ–¹ã‚‚å¤šã„ã¨æ€ã„ã¾ã™ã€‚ä»Šå›ã€`trn2.3xlarge` ã¨ã„ã†æ¯”è¼ƒçš„å°ã•ãª trn2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ãŸã®ã§å®Ÿéš›ã« Capacity Block ã‚’åˆ©ç”¨ã—ã¦ CDK ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã¾ã—ãŸã€‚

è©³ç´°ã¯ [Amazon EC2 Capacity Blocks for ML ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-capacity-blocks.html)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## AWS CDK ã§ Capacity Block ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•

Amazon EC2 Capacity Block ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã® 2 ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Launch Templateï¼ˆ`AWS::EC2::LaunchTemplate`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã—ã¾ã™ã€‚

1. **`InstanceMarketOptions.MarketType = "capacity-block"`**: Capacity Block ã®ä½¿ç”¨æŒ‡å®š
2. **`CapacityReservationSpecification.CapacityReservationTarget`**: äºˆç´„ Block ID ã‚’æŒ‡å®š

### å®Ÿè£…ä¾‹

```typescript:lib/torch-neuron-stack.ts
// Launch Templateç”¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
const launchTemplateData: any = {
  imageId: amiId,
  instanceType: props.instanceType,
  // ... ãã®ä»–ã®è¨­å®š ...
};

// Capacity Blockè¨­å®š
if (props.useCapacityBlock) {
  // âœ… InstanceMarketOptionsã‚’è¨­å®š
  launchTemplateData.instanceMarketOptions = {
    marketType: 'capacity-block',
  };
}

if (props.capacityReservationId) {
  // âœ… CapacityReservationSpecificationã‚’è¨­å®š
  launchTemplateData.capacityReservationSpecification = {
    capacityReservationTarget: {
      capacityReservationId: props.capacityReservationId,
    },
  };
}

// Launch Templateä½œæˆ
const launchTemplate = new ec2.CfnLaunchTemplate(this, 'CodeServerLaunchTemplate', {
  launchTemplateName: `${id}-LaunchTemplate`,
  launchTemplateData,
});

// Launch Templateã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•
const instance = new ec2.CfnInstance(this, 'CodeServerInstance', {
  launchTemplate: {
    launchTemplateId: launchTemplate.ref,
    version: launchTemplate.attrLatestVersionNumber,
  },
  subnetId: props.subnetId || undefined,
  // ... ã‚¿ã‚°ãªã© ...
});
```

### ãƒã‚¤ãƒ³ãƒˆ

1. **Launch Template ã®ä½¿ç”¨**: `AWS::EC2::LaunchTemplate` ã§ `InstanceMarketOptions` ã¨ `CapacityReservationSpecification` ã‚’è¨­å®š
2. **æ¡ä»¶åˆ†å²**: `useCapacityBlock` ãƒ•ãƒ©ã‚°ã§ Capacity Block ã®ä½¿ç”¨ã‚’åˆ¶å¾¡

## Capacity Block ã®è³¼å…¥ã‹ã‚‰èµ·å‹•ã¾ã§ã®ãƒ•ãƒ­ãƒ¼

Capacity Block ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã® 3 ã‚¹ãƒ†ãƒƒãƒ—ã§é€²ã‚ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—1: Capacity Block ã®æ¤œç´¢ã¨è³¼å…¥

ä»Šå›ä½œã£ãŸ CLI ã‚’ãƒ©ãƒƒãƒ—ã—ãŸç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€åˆ©ç”¨å¯èƒ½ãª Capacity Block ã‚’æ¤œç´¢ãƒ»è³¼å…¥ã—ã¾ã™ã€‚

```bash
# 1. åˆ©ç”¨å¯èƒ½ãªCapacity Blockã‚’æ¤œç´¢
./scripts/manage-capacity-block.sh search \
  -t trn2.3xlarge \
  -d 1 \
  -r sa-east-1

# 2. è³¼å…¥ï¼ˆOffering IDã¯æ¤œç´¢çµæœã‹ã‚‰å–å¾—ï¼‰
./scripts/manage-capacity-block.sh purchase \
  --offering-id cbr-XXXXX \
  --start-time 2026-01-27T00:00:00Z \
  -r sa-east-1
```

è³¼å…¥æ™‚ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè‡ªå‹•çš„ã«ä»¥ä¸‹ã®æƒ…å ±ã‚’ AWS Systems Manager Parameter Store ã«ä¿å­˜ã—ã¾ã™ã€‚

- `/capacity-block/{region}/reservation-id`
- `/capacity-block/{region}/subnet-id`

ã“ã®è‡ªå‹•ä¿å­˜ã«ã‚ˆã‚Šã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«æ‰‹å‹•ã§ ID ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚

#### ãã®ä»–ã®ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰

```bash
# è³¼å…¥æ¸ˆã¿ã€€Capacity Blockã€€ã®ä¸€è¦§è¡¨ç¤º
./scripts/manage-capacity-block.sh list -r sa-east-1

# Capacity Blockã€€ã®è©³ç´°æƒ…å ±è¡¨ç¤º
./scripts/manage-capacity-block.sh describe \
  --reservation-id cr-XXXXX \
  -r sa-east-1

# Parameter Storeã‹ã‚‰èª­ã¿è¾¼ã¿
./scripts/manage-capacity-block.sh load-params -r sa-east-1

# Capacity Blockã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæ³¨æ„ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ï¼‰
./scripts/manage-capacity-block.sh cancel \
  --reservation-id cr-XXXXX \
  -r sa-east-1
```

### ã‚¹ãƒ†ãƒƒãƒ—2: CDK ãƒ‡ãƒ—ãƒ­ã‚¤

çµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ`deploy.sh`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```bash
# Parameter Storeã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿ï¼ˆæ¨å¥¨ï¼‰
./scripts/deploy.sh --use-capacity-block -r sa-east-1

# ã¾ãŸã¯ã€IDã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
./scripts/deploy.sh \
  --use-capacity-block \
  --capacity-reservation-id cr-XXXXX \
  --subnet-id subnet-XXXXX \
  -r sa-east-1
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ã€‚

1. CDK ã‚¹ã‚¿ãƒƒã‚¯ã®ãƒ‡ãƒ—ãƒ­ã‚¤
2. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®èµ·å‹•
3. Code Server ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
4. æ¥ç¶šæƒ…å ±ã®è¡¨ç¤º

#### deploy.sh ã®ä¾¿åˆ©ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³

```bash
# é€šå¸¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCapacity Block ä¸ä½¿ç”¨ï¼‰
./scripts/deploy.sh -r sa-east-1

# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®š
./scripts/deploy.sh -t inf2.8xlarge -r sa-east-1

# ç‰¹å®š IP ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
./scripts/deploy.sh --allowed-ip 203.0.113.10/32 -r sa-east-1

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•ã®ã¿ï¼‰
./scripts/deploy.sh --skip-setup -r sa-east-1

# ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã‚¹ã‚¿ãƒƒã‚¯ã®æƒ…å ±ã‚’è¡¨ç¤º
./scripts/deploy.sh --show-info -r sa-east-1

# ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰Šé™¤
./scripts/deploy.sh --destroy -r sa-east-1
```

### ã‚¹ãƒ†ãƒƒãƒ—3: Code Server ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰

`deploy.sh` ãŒè‡ªå‹•çš„ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™ãŒã€æ‰‹å‹•ã§ã‚‚å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚

## ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•å¾Œã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆæµã—è¾¼ã¿

å‰ã®è¨˜äº‹ã§ä½œã£ãŸ Amazon EC2 User Data ã«ã‚ˆã‚‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¯è¤‡æ•°ã®ãƒ„ãƒ©ãƒŸãŒã‚ã‚Šã¾ã—ãŸã€‚1 ã¤ç›®ã¯ã€å¤±æ•—ã™ã‚‹ã¨ AWS CloudFormation å…¨ä½“ã‚’ã‚„ã‚Šç›´ã™å¿…è¦ãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚ã‚¹ã‚¿ãƒƒã‚¯ã®å‰Šé™¤ã‹ã‚‰å†ä½œæˆã¾ã§æ•°ååˆ†ã‹ã‹ã‚Šã€ãƒ‡ãƒãƒƒã‚°ã«è†¨å¤§ãªæ™‚é–“ã‚’æµªè²»ã—ã¦æ¶™ã‚’æµã—ã¦ã„ã¾ã—ãŸã€‚2 ã¤ç›®ã¯ã€ãƒ­ã‚°ãŒè¦‹ã¥ã‚‰ãã€`/var/log/cloud-init-output.log` ã‚„ CloudWatch Logs ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚¨ãƒ©ãƒ¼ã®åŸå› ç‰¹å®šãŒã‚ã‚“ã©ãã•ã„ã“ã¨ã§ã™ã€‚

### AWS Systems Manager Run Command ã«ã‚ˆã‚‹è§£æ±º

ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€AWS Systems Manager ã® Run Command ã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ä»¥ä¸‹ã®å›³ã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚JSON ã‚¿ã‚¹ã‚¯å®šç¾©ã‹ã‚‰ AWS Systems Manager Run Command ã‚’é€šã˜ã¦ Amazon EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æµã‚Œã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚

```mermaid
%%{init: {'theme':'dark','themeVariables': {'primaryColor':'#1f2937','primaryTextColor':'#fff','primaryBorderColor':'#4b5563','lineColor':'#9ca3af','secondaryColor':'#374151','tertiaryColor':'#1f2937'}}}%%
graph TD
    A[JSONã‚¿ã‚¹ã‚¯å®šç¾©<br/>code-server-setup.json] -->|èª­ã¿è¾¼ã¿| B[ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼<br/>run-tasks.sh]
    B -->|å®Ÿè¡Œ| C[AWS Systems Manager<br/>Run Command]
    C -->|ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ| D[Amazon EC2 Instance]
    B -->|ä¿å­˜| E[çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«<br/>task-state.json]
    
    style A fill:#1e40af,stroke:#3b82f6,color:#fff
    style B fill:#15803d,stroke:#22c55e,color:#fff
    style C fill:#7c2d12,stroke:#f97316,color:#fff
    style D fill:#6b21a8,stroke:#a855f7,color:#fff
    style E fill:#115e59,stroke:#14b8a6,color:#fff
```

JSON ã‚¿ã‚¹ã‚¯å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`code-server-setup.json`ï¼‰ã«ã¯ 17 å€‹ã®ç‹¬ç«‹ã—ãŸã‚¿ã‚¹ã‚¯ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€å„ã‚¿ã‚¹ã‚¯ã¯å€‹åˆ¥ã«å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆ`run-tasks.sh`ï¼‰ãŒ JSON å®šç¾©ã‚’èª­ã¿è¾¼ã¿ã€AWS Systems Manager Run Command ã‚’ä»‹ã—ã¦å„ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚é€²æ—ã¯çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã•ã‚Œã€å¤±æ•—ã—ãŸå ´åˆé€”ä¸­ã‹ã‚‰ã®å†å®Ÿè¡Œã‚’å®Ÿç¾ã—ã¾ã™ã€‚

#### çŠ¶æ…‹ç®¡ç†ã«ã‚ˆã‚‹å†ªç­‰æ€§

ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚’ `/tmp/task-state-{instance-id}.json` ã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€å†ªç­‰æ€§ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```json
{
  "tasks": {
    "01-configure-needrestart": {
      "name": "Configure needrestart",
      "status": "success",
      "timestamp": "2026-01-26T12:34:56.789Z",
      "command_id": "12345678-1234-1234-1234-123456789abc"
    },
    "02-cleanup-neuron-repo": {
      "name": "Cleanup old Neuron repository",
      "status": "success",
      "timestamp": "2026-01-26T12:35:01.234Z",
      "command_id": "23456789-2345-2345-2345-234567890bcd"
    }
  },
  "last_run": "2026-01-26T12:35:01.234Z"
}
```

ã“ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã¯è‡ªå‹•ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€å¤±æ•—ã—ãŸã‚¿ã‚¹ã‚¯ã‹ã‚‰å†é–‹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€AWS CloudFormation ã®å†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒä¸è¦ã«ãªã‚‹ãŸã‚ã€ç§å€‹äººã®ãƒ„ãƒ©ãƒŸãŒå¤§å¹…ã«ç·©å’Œã•ã‚Œã¾ã™ã€‚ã‚¿ã‚¹ã‚¯å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚Œã°å¥½ãã«ã‚³ãƒãƒ³ãƒ‰ã‚’æµã—è¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

### JSON ã‚¿ã‚¹ã‚¯å®šç¾©ã®æŸ”è»Ÿæ€§

ã™ã¹ã¦ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’ JSON å½¢å¼ã§å®šç¾©ã™ã‚‹ã“ã¨ã§ã€å¾Œã‹ã‚‰è‡ªç”±ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

```json:tasks/code-server-setup.json
{
  "name": "Code Server Setup",
  "description": "Code Serverã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®š",
  "variables": {
    "USER": "coder",
    "PASSWORD": "",
    "HOME_DIR": "/work",
    "INTERNAL_PORT": "8080",
    "NGINX_PORT": "80"
  },
  "tasks": [
    {
      "id": "01-configure-needrestart",
      "name": "Configure needrestart",
      "description": "needrestartã®è¨­å®šã‚’å¤‰æ›´",
      "commands": [
        "echo '==> Configuring needrestart settings'",
        "sed -i 's/#$nrconf{restart} = \"i\";/$nrconf{restart} = \"a\";/' /etc/needrestart/needrestart.conf"
      ]
    },
    {
      "id": "09-install-code-server",
      "name": "Install Code Server",
      "description": "Code Serverã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«",
      "commands": [
        "echo '==> Installing Code Server'",
        "curl -fsSL https://code-server.dev/install.sh | sh"
      ]
    }
    // ... å…¨17ã‚¿ã‚¹ã‚¯
  ]
}
```

å¤‰æ•°ã®ç½®æ›ã‚‚å¯èƒ½ã§ã™ã€‚

```json
{
  "commands": [
    "adduser --disabled-password --gecos '' {{USER}}",
    "chown -R {{USER}}:{{USER}} {{HOME_DIR}}"
  ]
}
```

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ‰‹å‹•å®Ÿè¡Œ

`deploy.sh` ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ãŒã€ä»¥ä¸‹ã®å ´åˆã¯æ‰‹å‹•å®Ÿè¡ŒãŒå¿…è¦ã§ã™ã€‚

1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¤±æ•—ã—ãŸå ´åˆ
2. `--skip-setup` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå ´åˆ
3. è¨­å®šã‚’å¤‰æ›´ã—ã¦å†å®Ÿè¡Œã—ãŸã„å ´åˆ

#### Secret ARN ã«ã¤ã„ã¦

`-s` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æŒ‡å®šã™ã‚‹ Secret ARN ã¯ã€**CDK ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è‡ªå‹•çš„ã«ä½œæˆ**ã•ã‚Œã¾ã™ã€‚

```typescript
// CDKã‚¹ã‚¿ãƒƒã‚¯ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
const password = new secretsmanager.Secret(this, 'CodeServerPassword', {
  description: 'Code-server password',
  generateSecretString: {
    excludePunctuation: true,
    passwordLength: 16,
  },
});
```

é€šå¸¸ã¯ `deploy.sh` ãŒè‡ªå‹•çš„ã« Secret ARN ã‚’å–å¾—ã—ã¦æ¸¡ã—ã¾ã™ãŒã€æ‰‹å‹•å®Ÿè¡Œã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®æ–¹æ³•ã§ç¢ºèªã§ãã¾ã™ï¼š

```bash
# æ–¹æ³•1: AWS CLIã§æ¤œç´¢
aws secretsmanager list-secrets \
  --region sa-east-1 \
  --query "SecretList[?contains(Name, 'CodeServerPassword')].ARN" \
  --output text

# æ–¹æ³•2: deploy.sh ã® --show-info ã‚ªãƒ—ã‚·ãƒ§ãƒ³
./scripts/deploy.sh --show-info -r sa-east-1
# â†’ Secret ARN ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å–å¾—ã‚³ãƒãƒ³ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

#### å®Ÿè¡Œä¾‹

```bash
# åŸºæœ¬çš„ãªå®Ÿè¡Œ
./scripts/setup-code-server.sh \
  -i i-1234567890abcdef0 \
  -r sa-east-1 \
  -s arn:aws:secretsmanager:sa-east-1:123456789012:secret:CodeServerPassword-XXXXX

# å¤±æ•—ã—ãŸã‚¿ã‚¹ã‚¯ã‹ã‚‰å†é–‹ï¼ˆä¾‹ï¼šã‚¿ã‚¹ã‚¯09ã‹ã‚‰ï¼‰
./scripts/setup-code-server.sh \
  -i i-1234567890abcdef0 \
  -r sa-east-1 \
  -s arn:aws:secretsmanager:... \
  --start-from 09-install-code-server

# ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå®Ÿè¡Œå†…å®¹ã®ç¢ºèªï¼‰
./scripts/setup-code-server.sh \
  -i i-1234567890abcdef0 \
  -r sa-east-1 \
  --dry-run
```

ã‚¹ã‚¿ãƒƒã‚¯ã®å†ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ä¸è¦ã§ã€å¤±æ•—ã—ãŸç®‡æ‰€ã‹ã‚‰æ•°åˆ†ã§å†é–‹ã§ãã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®å…¨ä½“åƒ

å®Ÿè£…ã—ãŸ 17 ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å†…å®¹ã‚’ä»¥ä¸‹ã®è¡¨ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚

| # | ã‚¿ã‚¹ã‚¯å | èª¬æ˜ | å†å®Ÿè¡Œ |
|---|---------|------|-------|
| 01 | configure-needrestart | needrestart è¨­å®šã®å¤‰æ›´ | âœ… |
| 02 | cleanup-neuron-repo | å¤ã„ Neuron ãƒªãƒã‚¸ãƒˆãƒªå‰Šé™¤ | âœ… |
| 03 | wait-for-dpkg-lock | dpkg ãƒ­ãƒƒã‚¯å¾…æ©Ÿ | âœ… |
| 04 | install-base-packages | åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | âœ… |
| 05 | create-user | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ | âœ… |
| 06 | configure-sudo | sudo æ¨©é™è¨­å®š | âš ï¸ |
| 07 | create-home-dir | ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ | âœ… |
| 08 | configure-profile | ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š | âš ï¸ |
| 09 | install-code-server | Code Server ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | âœ… |
| 10 | configure-code-server | Code Server è¨­å®š | âš ï¸ |
| 11 | configure-vscode-settings | VS Code è¨­å®š | âš ï¸ |
| 12 | configure-nginx | nginx è¨­å®š | âš ï¸ |
| 13 | create-systemd-service | systemd ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆ | âš ï¸ |
| 14 | enable-and-start-service | ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹• | âš ï¸ |
| 15 | install-vscode-extensions | VS Code æ‹¡å¼µæ©Ÿèƒ½ | âš ï¸ |
| 16 | create-code-command | code ã‚³ãƒãƒ³ãƒ‰ä½œæˆ | âš ï¸ |
| 17 | verify-installation | ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¤œè¨¼ | âœ… |

- âœ… ä½•åº¦å®Ÿè¡Œã—ã¦ã‚‚å®‰å…¨
- âš ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã¾ãŸã¯ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•

### ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ã®å®Ÿè£…

ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆ`run-tasks.sh`ï¼‰ã¯ã€Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

```python
# ã‚¿ã‚¹ã‚¯å®Ÿè¡Œé–¢æ•°ï¼ˆæŠœç²‹ï¼‰
def execute_task(task_id, commands):
    """ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ"""
    script = '\n'.join(commands)
    
    # SSM send-commandå®Ÿè¡Œ
    result = subprocess.run(
        ['aws', 'ssm', 'send-command',
         '--region', region,
         '--instance-ids', instance_id,
         '--document-name', 'AWS-RunShellScript',
         '--parameters', json.dumps({'commands': [script]})],
        capture_output=True
    )
    
    # å®Œäº†å¾…æ©Ÿã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
    # ...
    
    return {
        'status': 'success',
        'command_id': command_id,
        'output': output
    }
```

## å®Ÿéš›ã®ä½¿ç”¨ä¾‹

å®Ÿéš›ã« Capacity Block ã‚’ä½¿ç”¨ã—ã¦ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ä¸€é€£ã®æµã‚Œã‚’ç¤ºã—ã¾ã™ã€‚

### ä¾‹ 1: åŸºæœ¬çš„ãªä½¿ã„æ–¹

```bash
# 1. Capacity Block ã‚’æ¤œç´¢
./scripts/manage-capacity-block.sh search -t trn2.3xlarge -d 1 -r sa-east-1

# 2. Capacity Block ã‚’è³¼å…¥ï¼ˆæ¤œç´¢çµæœã® Offering ID ã‚’ä½¿ç”¨ï¼‰
./scripts/manage-capacity-block.sh purchase \
  --offering-id cbr-XXXXX \
  --start-time 2026-01-27T00:00:00Z \
  -r sa-east-1
# â†’ è³¼å…¥å®Œäº†æ™‚ã€Parameter Storeã«è‡ªå‹•ä¿å­˜ã•ã‚Œã‚‹

# 3. ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆParameter Store ã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿ï¼‰
./scripts/deploy.sh --use-capacity-block -r sa-east-1
# â†’ CDK ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹• â†’ Code Server ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒè‡ªå‹•å®Ÿè¡Œ
```

### ä¾‹2: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¤±æ•—ã—ãŸå ´åˆ

```bash
# 1. å¤±æ•—ã—ãŸç®‡æ‰€ã‹ã‚‰å†å®Ÿè¡Œ
./scripts/setup-code-server.sh \
  -i i-XXXXX \
  -r sa-east-1 \
  -s arn:aws:secretsmanager:...:secret:CodeServerPassword-XXXXX \
  --start-from 09-install-code-server

# 2. æ¥ç¶šç¢ºèª
./scripts/deploy.sh --show-info -r sa-east-1
```

### ä¾‹3: æ—¢å­˜ã®ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±ã‚’ç¢ºèª

```bash
# ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±ã‚’è¡¨ç¤º
./scripts/deploy.sh --show-info -r sa-east-1
```

**å‡ºåŠ›ä¾‹ï¼š**

```bash
CDK ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: /work/samples/aws-neuron/torch-neuronx/multi-framework-dlami-ubuntu24-cdk
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: sa-east-1
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—: trn2.3xlarge
Capacity Block: false
ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚µã‚¤ã‚º: 500GB

ğŸ“Š ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±ã‚’å–å¾—ä¸­...

ã‚¹ã‚¿ãƒƒã‚¯å: TorchNeuron-CDK
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: UPDATE_COMPLETE
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: sa-east-1

ğŸ“‹ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æƒ…å ±:
  Instance ID: i-0a1b2c3d4e5f67890
  Public DNS: ec2-12-34-56-78.sa-east-1.compute.amazonaws.com
  Public IP: 12.34.56.78

ğŸ” ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è©³ç´°æƒ…å ±:
  State: running
  Instance Type: trn2.3xlarge
  Availability Zone: sa-east-1b
  Launch Time: 2026-01-26T11:33:42+00:00

ğŸ” æ¥ç¶šæƒ…å ±:
  Code Server URL: http://ec2-12-34-56-78.sa-east-1.compute.amazonaws.com

  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å–å¾—ã‚³ãƒãƒ³ãƒ‰:
    aws secretsmanager get-secret-value \
      --secret-id arn:aws:secretsmanager:sa-east-1:012345678901:secret:CodeServerPasswordA9061133-Abc1Def2Ghi3-Jk4Lmn \
      --region sa-east-1 \
      --query 'SecretString' \
      --output text

  SSMæ¥ç¶šã‚³ãƒãƒ³ãƒ‰:
    aws ssm start-session --target i-0a1b2c3d4e5f67890 --region sa-east-1
```

ã“ã®å‡ºåŠ›ã‹ã‚‰ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDã€æ¥ç¶šURLã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å–å¾—æ–¹æ³•ãªã©ã®å¿…è¦ãªæƒ…å ±ãŒã™ã¹ã¦ç¢ºèªã§ãã¾ã™ã€‚

### ä¾‹4: ç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```bash
# ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰Šé™¤
./scripts/deploy.sh --destroy -r sa-east-1

# Capacity Blockã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹å ´åˆï¼ˆæ³¨æ„ï¼šæ–™é‡‘ç™ºç”Ÿã®å¯èƒ½æ€§ï¼‰
./scripts/manage-capacity-block.sh cancel \
  --reservation-id cr-XXXXX \
  -r sa-east-1
```

## ã¾ã¨ã‚

æœ¬è¨˜äº‹ã§ã¯ã€AWS CDK ã‚’ä½¿ç”¨ã—ã¦ Amazon EC2 Capacity Block ã§ Trainium ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®å®Ÿè£…ã«ã‚ˆã‚Šå€‹äººçš„ãªãƒ„ãƒ©ãƒŸãŒè»½æ¸›ã•ã‚Œã¾ã—ãŸã€‚

## å‚è€ƒãƒªãƒ³ã‚¯

- [GitHub ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/littlemex/ec2-cfn-templates-for-genai/tree/main/samples/aws-neuron/torch-neuronx/multi-framework-dlami-ubuntu24-cdk)
- [AWS EC2 Capacity Blocks](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-capacity-blocks.html)
- [Launch instances using Capacity Blocks](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/capacity-blocks-launch.html)
- [AWS::EC2::LaunchTemplate - CloudFormation](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-launchtemplate.html)
- [InstanceMarketOptions - CloudFormation](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-launchtemplate-instancemarketoptions.html)
- [AWS Neuron Documentation](https://awsdocs-neuron.readthedocs-hosted.com/)
- [AWS CDK Documentation](https://docs.aws.amazon.com/cdk/)
