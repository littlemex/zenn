---
title: "Amazon SageMakerã‚’ä½¿ç”¨ã—ãŸRayãƒ™ãƒ¼ã‚¹ã®æ©Ÿæ¢°å­¦ç¿’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

Translation: https://aws.amazon.com/jp/blogs/machine-learning/orchestrate-ray-based-machine-learning-workflows-using-amazon-sagemaker/

Raju Ranganã¨Sherry Dingã«ã‚ˆã‚‹2023å¹´9æœˆ18æ—¥ã®æŠ•ç¨¿ [Amazon SageMaker](https://aws.amazon.com/blogs/machine-learning/category/artificial-intelligence/sagemaker/ "Amazon SageMakerã®ã™ã¹ã¦ã®æŠ•ç¨¿ã‚’è¡¨ç¤º"), [ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](https://aws.amazon.com/blogs/machine-learning/category/post-types/best-practices/ "ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ã™ã¹ã¦ã®æŠ•ç¨¿ã‚’è¡¨ç¤º"), [ä¸­ç´šï¼ˆ200ï¼‰](https://aws.amazon.com/blogs/machine-learning/category/learning-levels/intermediate-200/ "ä¸­ç´šï¼ˆ200ï¼‰ã®ã™ã¹ã¦ã®æŠ•ç¨¿ã‚’è¡¨ç¤º"), [æŠ€è¡“çš„ãƒã‚¦ãƒ„ãƒ¼](https://aws.amazon.com/blogs/machine-learning/category/post-types/technical-how-to/ "æŠ€è¡“çš„ãƒã‚¦ãƒ„ãƒ¼ã®ã™ã¹ã¦ã®æŠ•ç¨¿ã‚’è¡¨ç¤º")

æ©Ÿæ¢°å­¦ç¿’ï¼ˆMLï¼‰ã¯ã€ãŠå®¢æ§˜ãŒã‚ˆã‚Šè¤‡é›‘ãªèª²é¡Œã‚’è§£æ±ºã—ã‚ˆã†ã¨ã™ã‚‹ã«ã¤ã‚Œã¦ã€ã¾ã™ã¾ã™è¤‡é›‘ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã®è¤‡é›‘ã•ã«ã‚ˆã‚Šã€å¤šãã®å ´åˆã€å˜ä¸€ã®ãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´ã™ã‚‹ãŸã‚ã«è¤‡æ•°ã®ãƒã‚·ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹åˆ†æ•£MLã®å¿…è¦æ€§ãŒç”Ÿã˜ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è¤‡æ•°ã®ãƒãƒ¼ãƒ‰ã«ã‚ãŸã£ã¦ã‚¿ã‚¹ã‚¯ã‚’ä¸¦åˆ—åŒ–ã§ãã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“ã®çŸ­ç¸®ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Šã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ã«ã¤ãªãŒã‚Šã¾ã™ãŒã€åˆ†æ•£ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’åŠ¹æœçš„ã«ä½¿ç”¨ã™ã‚‹ã«ã¯å¤§ããªèª²é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ãƒ†ã‚£ã‚¹ãƒˆã¯ã€ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²ã€è² è·åˆ†æ•£ã€éšœå®³è€æ€§ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãªã©ã®èª²é¡Œã«å¯¾å‡¦ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚MLã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¯ã€ä¸¦åˆ—åŒ–ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã€éšœå®³ã€å†è©¦è¡Œã‚’æ‰‹å‹•ã§å‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€è¤‡é›‘ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚

ã“ã®ãƒã‚¹ãƒˆã§ã¯ã€åˆ†æ•£MLã«ãŠã‘ã‚‹[Ray](https://www.ray.io/)ã¨[Amazon SageMaker](https://aws.amazon.com/sagemaker/)ã®åˆ©ç‚¹ã«ã¤ã„ã¦èª¬æ˜ã—ã€ã“ã‚Œã‚‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªMLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ãŠã‚ˆã³ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¬ã‚¤ãƒ‰ã‚’æä¾›ã—ã¾ã™ã€‚

Rayã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®åˆ†æ•£ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€MLãƒ¢ãƒ‡ãƒ«ã®åˆ†æ•£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã®ãŸã‚ã®æŸ”è»Ÿãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æä¾›ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†ã€åˆ†æ•£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã€å¼·åŒ–å­¦ç¿’ã€ãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒ“ãƒ³ã‚°ãªã©ã®ä¸€èˆ¬çš„ãªMLã‚¿ã‚¹ã‚¯å‘ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é€šã˜ã¦ã€ä½ãƒ¬ãƒ™ãƒ«ã®åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°ã‚’æŠ½è±¡åŒ–ã—ã¾ã™ã€‚

SageMakerã¯ã€MLãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãŸã‚ã®ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚Rayã¯SageMakerã®æ©Ÿèƒ½ã¨ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«çµ±åˆã—ã¦ã€åŠ¹ç‡çš„ã§ä¿¡é ¼æ€§ã®é«˜ã„è¤‡é›‘ãªMLãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰ãŠã‚ˆã³ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚Rayã¨SageMakerã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚Šã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªMLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãŸã‚ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®æ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã€ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ãŒã‚ã‚Šã¾ã™ï¼š

* Rayã®åˆ†æ•£ã‚¢ã‚¯ã‚¿ãƒ¼ã¨ä¸¦åˆ—å‡¦ç†æ§‹é€ ã«ã‚ˆã‚Šã€åˆ†æ•£ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºãŒç°¡ç´ åŒ–ã•ã‚Œã¾ã™ã€‚
* Ray AI Runtimeï¼ˆAIRï¼‰ã«ã‚ˆã‚Šã€é–‹ç™ºã‹ã‚‰æœ¬ç•ªç’°å¢ƒã¸ã®ç§»è¡Œã®æ‘©æ“¦ãŒè»½æ¸›ã•ã‚Œã¾ã™ã€‚Rayã¨AIRã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€åŒã˜Pythonã‚³ãƒ¼ãƒ‰ãŒãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ—ã‹ã‚‰å¤§è¦æ¨¡ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¾ã§ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ã‚¹ã‚±ãƒ¼ãƒ«ã—ã¾ã™ã€‚
* SageMakerã®ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã¨ã€å‡¦ç†ã‚¸ãƒ§ãƒ–ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¸ãƒ§ãƒ–ã€ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¸ãƒ§ãƒ–ãªã©ã®æ©Ÿèƒ½ã¯ã€åˆ†æ•£ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãŸã‚ã«Rayãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
* [Amazon SageMaker Experiments](https://aws.amazon.com/sagemaker/experiments/)ã«ã‚ˆã‚Šã€è¿…é€Ÿãªåå¾©ã¨ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã®è¿½è·¡ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
* [Amazon SageMaker Feature Store](https://aws.amazon.com/sagemaker/feature-store/)ã¯ã€ãƒ¢ãƒ‡ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ãŸã‚ã®MLç‰¹å¾´é‡ã‚’ä¿å­˜ã€å–å¾—ã€å…±æœ‰ã™ã‚‹ãŸã‚ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªãƒªãƒã‚¸ãƒˆãƒªã‚’æä¾›ã—ã¾ã™ã€‚
* ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¯ã€ã‚¬ãƒãƒŠãƒ³ã‚¹ã¨ç®¡ç†ã®ãŸã‚ã«[Amazon SageMaker Model Registry](https://docs.aws.amazon.com/sagemaker/latest/dg/model-registry.html)ã«ä¿å­˜ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã€è¿½è·¡ã§ãã¾ã™ã€‚
* [Amazon SageMaker Pipelines](https://aws.amazon.com/sagemaker/pipelines/)ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®MLãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚

## ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦

ã“ã®ãƒã‚¹ãƒˆã§ã¯ã€Rayã¨SageMakerã‚’ä¸€ç·’ã«ä½¿ç”¨ã™ã‚‹åˆ©ç‚¹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚SageMaker Pipelinesã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®Rayãƒ™ãƒ¼ã‚¹MLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã¯ã€Rayã‚¢ã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚¹ãƒˆã‚¢ã¸ã®ãƒ‡ãƒ¼ã‚¿ã®ä¸¦åˆ—å–ã‚Šè¾¼ã¿ã€Ray Dataã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†ã€Ray Trainã¨ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–ï¼ˆHPOï¼‰ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¸ãƒ§ãƒ–ã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚±ãƒ¼ãƒ«ã§ã®ãƒ¢ãƒ‡ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã€ãã—ã¦ãƒ¢ãƒ‡ãƒ«è©•ä¾¡ã¨ãƒ¢ãƒ‡ãƒ«ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸ã®ãƒ¢ãƒ‡ãƒ«ç™»éŒ²ãŒå«ã¾ã‚Œã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã¯ã€8ã¤ã®ç‰¹å¾´ï¼ˆ`YEAR_BUILT`ã€`SQUARE_FEET`ã€`NUM_BEDROOM`ã€`NUM_BATHROOMS`ã€`LOT_ACRES`ã€`GARAGE_SPACES`ã€`FRONT_PORCH`ã€`DECK`ï¼‰ã‚’æŒã¤[åˆæˆä½å®…ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ](https://github.com/aws-samples/mlops-amazon-sagemaker/tree/master/mlops-roadshow/data/raw)ã‚’ä½¿ç”¨ã—ã€ãƒ¢ãƒ‡ãƒ«ã¯ä½å®…ã®`PRICE`ã‚’äºˆæ¸¬ã—ã¾ã™ã€‚

MLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å„æ®µéšã¯ã€å…¥åŠ›ã¨å‡ºåŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–ã‚‹ç‹¬è‡ªã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æŒã¤å€‹åˆ¥ã®ã‚¹ãƒ†ãƒƒãƒ—ã«åˆ†å‰²ã•ã‚Œã¦ã„ã¾ã™ã€‚æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ã®ä¸»è¦ãªã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã¯[aws-samples-for-ray GitHubãƒªãƒã‚¸ãƒˆãƒª](https://github.com/aws-samples/aws-samples-for-ray/tree/main/sagemaker/distributed-xgb-sm-pipeline)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å‰ææ¡ä»¶

SageMaker Python SDKã‚’ä½¿ç”¨ã—ã€ã“ã®ãƒã‚¹ãƒˆã«é–¢é€£ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®å‰ææ¡ä»¶ãŒå¿…è¦ã§ã™ï¼š

* ã™ã¹ã¦ã®AWSãƒªã‚½ãƒ¼ã‚¹ã‚’å«ã‚€AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
* [Amazon SageMaker Studio](https://docs.aws.amazon.com/sagemaker/latest/dg/studio.html)ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã€SageMaker Feature Storeã€SageMaker Model Registryã€SageMaker Pipelinesã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã¤[AWS Identity and Access Management](https://aws.amazon.com/iam/)ï¼ˆIAMï¼‰ãƒ­ãƒ¼ãƒ«

## SageMaker Feature Storeã¸ã®ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿

MLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€CSVå½¢å¼ã®[Amazon Simple Storage Service](https://aws.amazon.com/s3/)ï¼ˆAmazon S3ï¼‰ã‹ã‚‰ã‚½ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚Šã€SageMaker Feature Storeã«å–ã‚Šè¾¼ã‚€ã“ã¨ã§ã™ã€‚SageMaker Feature Storeã¯ã€ãƒãƒ¼ãƒ ãŒMLç‰¹å¾´é‡ã‚’ä½œæˆã€å…±æœ‰ã€ç®¡ç†ã™ã‚‹ã“ã¨ã‚’å®¹æ˜“ã«ã™ã‚‹ç›®çš„ã«ç‰¹åŒ–ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã§ã™ã€‚ç‰¹å¾´é‡ã®ç™ºè¦‹ã€å†åˆ©ç”¨ã€å…±æœ‰ã‚’ç°¡ç´ åŒ–ã—ã€é¡§å®¢ãƒãƒ¼ãƒ å†…ã§ã®é–‹ç™ºã®é«˜é€ŸåŒ–ã€ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å¢—åŠ ã€ã‚³ã‚¹ãƒˆå‰Šæ¸›ã«ã¤ãªãŒã‚Šã¾ã™ã€‚

ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚¹ãƒˆã‚¢ã¸ã®ç‰¹å¾´é‡ã®å–ã‚Šè¾¼ã¿ã«ã¯ã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå«ã¾ã‚Œã¾ã™ï¼š

1. ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å®šç¾©ã—ã€ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚¹ãƒˆã‚¢ã«ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¾ã™ã€‚
2. ã‚½ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚¹ãƒˆã‚¢ç”¨ã«æº–å‚™ã—ã€å„ãƒ‡ãƒ¼ã‚¿è¡Œã«ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã¨ãƒ¬ã‚³ãƒ¼ãƒ‰IDã‚’è¿½åŠ ã—ã¾ã™ã€‚
3. Boto3 SDKã‚’ä½¿ç”¨ã—ã¦ã€æº–å‚™ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã«å–ã‚Šè¾¼ã¿ã¾ã™ã€‚

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Rayã‚’ä½¿ç”¨ã—ãŸå–ã‚Šè¾¼ã¿ã‚¿ã‚¹ã‚¯ã®ä¸¦åˆ—å‡¦ç†ã‚’å«ã‚€ã‚¹ãƒ†ãƒƒãƒ—3ã®ã¿ã‚’å¼·èª¿ã—ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã®å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã¯[GitHubãƒªãƒã‚¸ãƒˆãƒª](https://github.com/aws-samples/aws-samples-for-ray/blob/main/sagemaker/distributed-xgb-sm-pipeline/pipeline%5Fscripts/feature-store/script-fs.py)ã§ç¢ºèªã§ãã¾ã™ã€‚

[ingest\_features](https://github.com/aws-samples/aws-samples-for-ray/blob/main/sagemaker/distributed-xgb-sm-pipeline/pipeline%5Fscripts/feature-store/script-fs.py#L29)ãƒ¡ã‚½ãƒƒãƒ‰ã¯`Featurestore`ã¨ã„ã†ã‚¯ãƒ©ã‚¹å†…ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚`Featurestore`ã‚¯ãƒ©ã‚¹ã«ã¯`@ray.remote`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãŒä»˜ã„ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã€ã“ã®ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒRayã‚¢ã‚¯ã‚¿ãƒ¼ã€ã¤ã¾ã‚ŠRayå†…ã®çŠ¶æ…‹ã‚’æŒã¡ä¸¦è¡Œè¨ˆç®—ãƒ¦ãƒ‹ãƒƒãƒˆã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€Ray ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ç•°ãªã‚‹ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ã«ã‚ˆã£ã¦åŒæ™‚ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹åˆ†æ•£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã§ãã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚ã‚¢ã‚¯ã‚¿ãƒ¼ã¯ã€å¯å¤‰çŠ¶æ…‹ã‚’ç®¡ç†ãŠã‚ˆã³ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹æ–¹æ³•ã‚’æä¾›ã—ã€åˆ†æ•£ç’°å¢ƒã§è¤‡é›‘ãªçŠ¶æ…‹ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ä¸Šã§ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ã‚¯ã‚¿ãƒ¼ã§ãƒªã‚½ãƒ¼ã‚¹è¦ä»¶ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã®å ´åˆã€`FeatureStore`ã‚¯ãƒ©ã‚¹ã®å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯0.5 CPUãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã”è¦§ãã ã•ã„ï¼š

```
@ray.remote(num_cpus=0.5)
class Featurestore:
    def ingest_features(self,feature_group_name, df, region):
        """
        Ingest features to Feature Store Group
        Args:
            feature_group_name (str): Feature Group Name
            data_path (str): Path to the train/validation/test data in CSV format.
        """
        
        ...
```

`remote`ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã‚¢ã‚¯ã‚¿ãƒ¼ã¨å¯¾è©±ã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã‚¢ã‚¯ã‚¿ãƒ¼ã®å¸Œæœ›æ•°ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã¸ã®å…¥åŠ›å¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚Œã¾ã™ã€‚æ¬¡ã«ã€ãƒ‡ãƒ¼ã‚¿ã¯ã‚¢ã‚¯ã‚¿ãƒ¼ã®æ•°ã«åŸºã¥ã„ã¦åˆ†å‰²ã•ã‚Œã€ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚¹ãƒˆã‚¢ã«å–ã‚Šè¾¼ã‚€ãŸã‚ã«ãƒªãƒ¢ãƒ¼ãƒˆã®ä¸¦åˆ—ãƒ—ãƒ­ã‚»ã‚¹ã«æ¸¡ã•ã‚Œã¾ã™ã€‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‚ç…§ã«å¯¾ã—ã¦`get`ã‚’å‘¼ã³å‡ºã—ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆè¨ˆç®—ãŒå®Œäº†ã—çµæœãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œã‚’ãƒ–ãƒ­ãƒƒã‚¯ã§ãã¾ã™ã€‚çµæœãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¨ã€`ray.get`ã¯çµæœã‚’è¿”ã—ã€ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡ŒãŒç¶šè¡Œã•ã‚Œã¾ã™ã€‚

```
import modin.pandas as pd
import ray

df = pd.read_csv(s3_path)
data = prepare_df_for_feature_store(df)
# Split into partitions
partitions = [ray.put(part) for part in np.array_split(data, num_actors)]
# Start actors and assign partitions in a loop
actors = [Featurestore.remote() for _ in range(args.num_actors)]
results = []

for actor, partition in zip(actors, input_partitions):
    results.append(actor.ingest_features.remote(
                        args.feature_group_name, 
                        partition, args.region
                      )
                )

ray.get(results)
```

## ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€æ¤œè¨¼ã€ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿æº–å‚™

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Ray Datasetã‚’ä½¿ç”¨ã—ã¦ã€æ©Ÿæ¢°å­¦ç¿’ã®æº–å‚™ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’åŠ¹ç‡çš„ã«åˆ†å‰²ã€å¤‰æ›ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚Ray Datasetã¯ã€æ§˜ã€…ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã‚„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€Rayã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®æ¨™æº–çš„ãªæ–¹æ³•ã‚’æä¾›ã—ã¾ã™ã€‚ä¸¦åˆ—å¤‰æ›ã€ã‚·ãƒ£ãƒƒãƒ•ãƒªãƒ³ã‚°ã€ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã€é›†ç´„ãªã©ã®ä¸€èˆ¬çš„ãªMLå‰å‡¦ç†æ“ä½œã®ãŸã‚ã®APIã‚’æŒã£ã¦ã„ã¾ã™ã€‚Ray Datasetã¯ã€çŠ¶æ…‹ã®ã‚ã‚‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨GPUã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¿…è¦ã¨ã™ã‚‹æ“ä½œã‚‚å‡¦ç†ã—ã¾ã™ã€‚Sparkã€Pandasã€NumPyã€ãã®ä»–ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ãŠã‚ˆã³TensorFlowã‚„PyTorchãªã©ã®MLãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«çµ±åˆã•ã‚Œã€Rayã®ä¸Šã«ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨MLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚ç›®æ¨™ã¯ã€å®Ÿè·µè€…ã¨ç ”ç©¶è€…ã®ãŸã‚ã®åˆ†æ•£ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨MLã‚’å®¹æ˜“ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚

ã“ã®ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã¾ãšã€ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚¹ãƒˆã‚¢ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼š

```
def load_dataset(feature_group_name, region):
    """
    Loads the data as a ray dataset from the offline featurestore S3 location
    Args:
        feature_group_name (str): name of the feature group
    Returns:
        ds (ray.data.dataset): Ray dataset the contains the requested dat from the feature store
    """
    session = sagemaker.Session(boto3.Session(region_name=region))
    fs_group = FeatureGroup(
        name=feature_group_name, 
        sagemaker_session=session
    )

    fs_data_loc = fs_group.describe().get("OfflineStoreConfig").get("S3StorageConfig").get("ResolvedOutputS3Uri")
    
    # Drop columns added by the feature store
    # Since these are not related to the ML problem at hand
    cols_to_drop = ["record_id", "event_time","write_time", 
                    "api_invocation_time", "is_deleted", 
                    "year", "month", "day", "hour"]           

    ds = ray.data.read_parquet(fs_data_loc)
    ds = ds.drop_columns(cols_to_drop)
    print(f"{fs_data_loc} count is {ds.count()}")
    return ds

```

æ¬¡ã«ã€`ray.data`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªé«˜ãƒ¬ãƒ™ãƒ«ã®æŠ½è±¡åŒ–ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†å‰²ãŠã‚ˆã³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ã¾ã™ï¼š

```
def split_dataset(dataset, train_size, val_size, test_size, random_state=None):
    """
    Split dataset into train, validation and test samples
    Args:
        dataset (ray.data.Dataset): input data
        train_size (float): ratio of data to use as training dataset
        val_size (float): ratio of data to use as validation dataset
        test_size (float): ratio of data to use as test dataset
        random_state (int): Pass an int for reproducible output across multiple function calls.
    Returns:
        train_set (ray.data.Dataset): train dataset
        val_set (ray.data.Dataset): validation dataset
        test_set (ray.data.Dataset): test dataset
    """
    # Shuffle this dataset with a fixed random seed.
    shuffled_ds = dataset.random_shuffle(seed=random_state)
    # Split the data into train, validation and test datasets
    train_set, val_set, test_set = shuffled_ds.split_proportionately([train_size, val_size])
    return train_set, val_set, test_set

def scale_dataset(train_set, val_set, test_set, target_col):
    """
    Fit StandardScaler to train_set and apply it to val_set and test_set
    Args:
        train_set (ray.data.Dataset): train dataset
        val_set (ray.data.Dataset): validation dataset
        test_set (ray.data.Dataset): test dataset
        target_col (str): target col
    Returns:
        train_transformed (ray.data.Dataset): train data scaled
        val_transformed (ray.data.Dataset): val data scaled
        test_transformed (ray.data.Dataset): test data scaled
    """
    tranform_cols = dataset.columns()
    # Remove the target columns from being scaled
    tranform_cols.remove(target_col)
    # set up a standard scaler
    standard_scaler = StandardScaler(tranform_cols)
    # fit scaler to training dataset
    print("Fitting scaling to training data and transforming dataset...")
    train_set_transformed = standard_scaler.fit_transform(train_set)
    # apply scaler to validation and test datasets
    print("Transforming validation and test datasets...")
    val_set_transformed = standard_scaler.transform(val_set)
    test_set_transformed = standard_scaler.transform(test_set)
    return train_set_transformed, val_set_transformed, test_set_transformed

```

å‡¦ç†ã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€æ¤œè¨¼ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¯Amazon S3ã«ä¿å­˜ã•ã‚Œã€å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ã®å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã•ã‚Œã¾ã™ã€‚

## ãƒ¢ãƒ‡ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–ã®å®Ÿè¡Œ

ãƒ‡ãƒ¼ã‚¿ãŒå‰å‡¦ç†ã•ã‚Œã€ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®æº–å‚™ãŒã§ããŸã®ã§ã€MLãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã€äºˆæ¸¬æ€§èƒ½ã‚’æœ€å¤§åŒ–ã™ã‚‹ãŸã‚ã«ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¾®èª¿æ•´ã™ã‚‹æ™‚ãŒæ¥ã¾ã—ãŸã€‚Rayã«æ§‹ç¯‰ã•ã‚ŒãŸåˆ†æ•£ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã‚ã‚‹XGBoostã®[XGBoost-Ray](https://github.com/ray-project/xgboost%5Fray/tree/master)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è¤‡æ•°ã®ãƒãƒ¼ãƒ‰ã¨GPUã‚’ä½¿ç”¨ã—ã¦å¤§è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§XGBoostãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ãã¾ã™ã€‚XGBoostã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨äºˆæ¸¬APIã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ³ç½®ãæ›ãˆã‚’æä¾›ã—ã€åˆ†æ•£ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®è¤‡é›‘ã•ã‚’è£ã§å‡¦ç†ã—ã¾ã™ã€‚

è¤‡æ•°ã®ãƒãƒ¼ãƒ‰ã«ã‚ãŸã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®åˆ†æ•£ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã«ã€[RayHelper](https://github.com/aws-samples/aws-samples-for-ray/blob/main/sagemaker/distributed-xgb-sm-pipeline/common/sagemaker%5Fray%5Fhelper.py)ã¨ã„ã†åå‰ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ç¤ºã™ã‚ˆã†ã«ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¸ãƒ§ãƒ–ã®ãƒªã‚½ãƒ¼ã‚¹æ§‹æˆã‚’ä½¿ç”¨ã—ã€æœ€åˆã®ãƒ›ã‚¹ãƒˆã‚’ãƒ˜ãƒƒãƒ‰ãƒãƒ¼ãƒ‰ã¨ã—ã¦é¸æŠã—ã¾ã™ï¼š

```
class RayHelper():
    def __init__(self, ray_port:str="9339", redis_pass:str="redis_password"):
        ....
        self.resource_config = self.get_resource_config()
        self.head_host = self.resource_config["hosts"][0]
        self.n_hosts = len(self.resource_config["hosts"])
```

ãƒ›ã‚¹ãƒˆæƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¸ãƒ§ãƒ–ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å„ã€…ã§Rayã‚’ã©ã®ã‚ˆã†ã«åˆæœŸåŒ–ã™ã‚‹ã‹ã‚’æ±ºå®šã§ãã¾ã™ï¼š

```
def start_ray(self): 
   head_ip = self._get_ip_from_host()
   # If the current host is the host choosen as the head node
   # run `ray start` with specifying the --head flag making this is the head node
    if self.resource_config["current_host"] == self.head_host:
        output = subprocess.run(['ray', 'start', '--head', '-vvv', '--port', 
        self.ray_port, '--redis-password', self.redis_pass, 
        '--include-dashboard', 'false'], stdout=subprocess.PIPE)
        print(output.stdout.decode("utf-8"))
        ray.init(address="auto", include_dashboard=False)
        self._wait_for_workers()
        print("All workers present and accounted for")
        print(ray.cluster_resources())

    else:
       # If the current host is not the head node, 
       # run `ray start` with specifying ip address as the head_host as the head node
        time.sleep(10)
        output = subprocess.run(['ray', 'start', 
        f"--address={head_ip}:{self.ray_port}", 
        '--redis-password', self.redis_pass, "--block"], stdout=subprocess.PIPE)
        print(output.stdout.decode("utf-8"))
        sys.exit(0)

```

ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¸ãƒ§ãƒ–ãŒé–‹å§‹ã•ã‚Œã‚‹ã¨ã€`RayHelper`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§`start_ray()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§Rayã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–ã§ãã¾ã™ï¼š

```
if __name__ == '__main__':
    ray_helper = RayHelper()
    ray_helper.start_ray()
    args = read_parameters()
    sess = sagemaker.Session(boto3.Session(region_name=args.region))

```

æ¬¡ã«ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«XGBoost-Rayã‹ã‚‰XGBoostãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```
def train_xgboost(ds_train, ds_val, params, num_workers, target_col = "price") -> Result:
    """
    Creates a XGBoost trainer, train it, and return the result.        
    Args:
        ds_train (ray.data.dataset): Training dataset
        ds_val (ray.data.dataset): Validation dataset
        params (dict): Hyperparameters
        num_workers (int): number of workers to distribute the training across
        target_col (str): target column
    Returns:
        result (ray.air.result.Result): Result of the training job
    """
    
    train_set = RayDMatrix(ds_train, 'PRICE')
    val_set = RayDMatrix(ds_val, 'PRICE')
    
    evals_result = {}
    
    trainer = train(
        params=params,
        dtrain=train_set,
        evals_result=evals_result,
        evals=[(val_set, "validation")],
        verbose_eval=False,
        num_boost_round=100,
        ray_params=RayParams(num_actors=num_workers, cpus_per_actor=1),
    )
    
    output_path=os.path.join(args.model_dir, 'model.xgb')
    
    trainer.save_model(output_path)
    
    valMAE = evals_result["validation"]["mae"][-1]
    valRMSE = evals_result["validation"]["rmse"][-1]
 
    print('[3] #011validation-mae:{}'.format(valMAE))
    print('[4] #011validation-rmse:{}'.format(valRMSE))
    
    local_testing = False
    try:
        load_run(sagemaker_session=sess)
    except:
        local_testing = True
    if not local_testing: # Track experiment if using SageMaker Training
        with load_run(sagemaker_session=sess) as run:
            run.log_metric('validation-mae', valMAE)
            run.log_metric('validation-rmse', valRMSE)

```

`trainer`ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹éš›ã«ã€ã‚¢ã‚¯ã‚¿ãƒ¼æ•°ã¨å„ã‚¢ã‚¯ã‚¿ãƒ¼ã‚ãŸã‚Šã®CPUæ•°ã‚’å–ã‚‹`RayParams`ã‚’æ¸¡ã™ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚XGBoost-Rayã¯ã“ã®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã€Rayã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’åˆ†æ•£ã—ã¾ã™ã€‚

æ¬¡ã«ã€SageMaker Python SDKã«åŸºã¥ã„ã¦XGBoostã‚¨ã‚¹ãƒ†ã‚£ãƒ¡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ãã‚Œã‚’HPOã‚¸ãƒ§ãƒ–ã«ä½¿ç”¨ã—ã¾ã™ã€‚

## å‰è¿°ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’SageMaker Pipelinesã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹

ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§å†åˆ©ç”¨å¯èƒ½ãªMLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹ã«ã¯ã€å‰è¿°ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ãŸã‚ã®CI/CDãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚SageMaker Pipelinesã¯ã€SageMakerã€SageMaker Python SDKã€ãŠã‚ˆã³SageMaker Studioã¨ç›´æ¥çµ±åˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®çµ±åˆã«ã‚ˆã‚Šã€ä½¿ã„ã‚„ã™ã„Python SDKã‚’ä½¿ç”¨ã—ã¦MLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã—ã€SageMaker Studioã‚’ä½¿ç”¨ã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¦–è¦šåŒ–ãŠã‚ˆã³ç®¡ç†ã§ãã¾ã™ã€‚ã¾ãŸã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œå†…ã®ãƒ‡ãƒ¼ã‚¿ã®å±¥æ­´ã‚’è¿½è·¡ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

SageMaker Pipelinesã¯MLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’å«ã‚€æœ‰å‘éå·¡å›ã‚°ãƒ©ãƒ•ï¼ˆDAGï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚å„ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ã€ã‚¹ãƒ†ãƒƒãƒ—é–“ã®ãƒ‡ãƒ¼ã‚¿ä¾å­˜é–¢ä¿‚ã«ã‚ˆã£ã¦ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚Œã‚‹ç›¸äº’æ¥ç¶šã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—ã®ã‚·ãƒªãƒ¼ã‚ºã§ã‚ã‚Šã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å„å®Ÿè¡Œã«å…¥åŠ›å¤‰æ•°ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æä¾›ã§ãã¾ã™ã€‚SageMaker Pipelinesã«ã¯ã€`ParameterString`ã€`ParameterInteger`ã€`ParameterFloat`ã€`ParameterBoolean`ã®4ç¨®é¡ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ã„ãã¤ã‹ã®å…¥åŠ›å¤‰æ•°ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã—ã€ã‚¹ãƒ†ãƒƒãƒ—ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ§‹æˆã‚’è¨­å®šã—ã¾ã™ï¼š

```
processing_instance_count = ParameterInteger(
    name='ProcessingInstanceCount',
    default_value=1
)
feature_group_name = ParameterString(
    name='FeatureGroupName',
    default_value='fs-ray-synthetic-housing-data'
)
bucket_prefix = ParameterString(
    name='Bucket_Prefix',
    default_value='aws-ray-mlops-workshop/feature-store'
)
rmse_threshold = ParameterFloat(name="RMSEThreshold", default_value=15000.0)
    train_size = ParameterString(
    name='TrainSize',
    default_value="0.6"
)
val_size = ParameterString(
    name='ValidationSize',
    default_value="0.2"
)
test_size = ParameterString(
    name='TestSize',
    default_value="0.2"
)

cache_config = CacheConfig(enable_caching=True, expire_after="PT12H")

```

SageMaker Feature Storeå–ã‚Šè¾¼ã¿ç”¨ã¨ã€ãƒ‡ãƒ¼ã‚¿æº–å‚™ç”¨ã®2ã¤ã®å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€å‰è¿°ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨éå¸¸ã«ä¼¼ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚å”¯ä¸€ã®æ–°ã—ã„ã‚³ãƒ¼ãƒ‰è¡Œã¯ã€å‡¦ç†ã‚¸ãƒ§ãƒ–ã®æ§‹æˆã‚’å–å¾—ã—ã€ãã‚Œã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦å«ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã€ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©å¾Œã®`ProcessingStep`ã§ã™ã€‚ã•ã‚‰ã«ã€ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚¹ãƒ†ãƒƒãƒ—ãŒSageMaker Feature Storeå–ã‚Šè¾¼ã¿ã‚¹ãƒ†ãƒƒãƒ—ã«ä¾å­˜ã™ã‚‹ã“ã¨ã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã”è¦§ãã ã•ã„ï¼š

```
feature_store_ingestion_step = ProcessingStep(
    name='FeatureStoreIngestion',
    step_args=fs_processor_args,
    cache_config=cache_config
)

preprocess_dataset_step = ProcessingStep(
    name='PreprocessData',
    step_args=processor_args,
    cache_config=cache_config
)
preprocess_dataset_step.add_depends_on([feature_store_ingestion_step])

```

åŒæ§˜ã«ã€ãƒ¢ãƒ‡ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ§‹ç¯‰ã™ã‚‹ã«ã¯ã€ãƒ¢ãƒ‡ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚³ãƒ¼ãƒ‰ã®å¾Œã«`TuningStep`ã®å®šç¾©ã‚’è¿½åŠ ã—ã¦ã€SageMakerãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

```
tuning_step = TuningStep(
    name="HPTuning",
    tuner=tuner,
    inputs={
        "train": TrainingInput(
            s3_data=preprocess_dataset_step.properties.ProcessingOutputConfig.Outputs[
            "train"
            ].S3Output.S3Uri,
            content_type="text/csv"
        ),
        "validation": TrainingInput(
            s3_data=preprocess_dataset_step.properties.ProcessingOutputConfig.Outputs[
            "validation"
            ].S3Output.S3Uri,
            content_type="text/csv"
        )
    },
    cache_config=cache_config,
)
tuning_step.add_depends_on([preprocess_dataset_step])

```

ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒ†ãƒƒãƒ—ã®å¾Œã€æœ€è‰¯ã®ãƒ¢ãƒ‡ãƒ«ã‚’SageMaker Model Registryã«ç™»éŒ²ã™ã‚‹ã“ã¨ã‚’é¸æŠã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«å“è³ªã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«ã€æœ€è‰¯ã®ãƒ¢ãƒ‡ãƒ«ã®ç›®æ¨™ãƒ¡ãƒˆãƒªãƒƒã‚¯ï¼ˆRMSEï¼‰ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿`rmse_threshold`ã¨ã—ã¦å®šç¾©ã•ã‚ŒãŸé–¾å€¤ã¨æ¯”è¼ƒã™ã‚‹æœ€å°å“è³ªã‚²ãƒ¼ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã“ã®è©•ä¾¡ã‚’è¡Œã†ãŸã‚ã«ã€[è©•ä¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ](https://github.com/aws-samples/aws-samples-for-ray/blob/main/sagemaker/distributed-xgb-sm-pipeline/pipeline%5Fscripts/evaluate/script.py)ã‚’å®Ÿè¡Œã™ã‚‹åˆ¥ã®å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«è©•ä¾¡çµæœã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã©ã®ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã‚‹ã¹ãã‹ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã«å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’åˆ†æã™ã‚‹éš›ã«ç‰¹ã«å½¹ç«‹ã¡ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã”è¦§ãã ã•ã„ï¼š

```
# Specify where we'll store the model evaluation results so that other steps can access those results
evaluation_report = PropertyFile(
    name='EvaluationReport',
    output_name='evaluation',
    path='evaluation.json',
)

# A ProcessingStep is used to evaluate the performance of a selected model from the HPO step. 
# In this case, the top performing model is evaluated. 
evaluation_step = ProcessingStep(
    name='EvaluateModel',
    processor=evaluation_processor,
    inputs=[
        ProcessingInput(
            source=tuning_step.get_top_model_s3_uri(
                top_k=0, s3_bucket=bucket, prefix=s3_prefix
            ),
            destination='/opt/ml/processing/model',
        ),
        ProcessingInput(
            source=preprocess_dataset_step.properties.ProcessingOutputConfig.Outputs['test'].S3Output.S3Uri,
            destination='/opt/ml/processing/test',
        ),
    ],
    outputs=[
        ProcessingOutput(
            output_name='evaluation', source='/opt/ml/processing/evaluation'
        ),
    ],
    code='./pipeline_scripts/evaluate/script.py',
    property_files=[evaluation_report],
)

```

ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§æœ€è‰¯ã®ãƒ¢ãƒ‡ãƒ«ã‚’SageMaker Model Registryã«ç™»éŒ²ã™ã‚‹ãŸã‚ã®`ModelStep`ã‚’å®šç¾©ã—ã¾ã™ã€‚æœ€è‰¯ã®ãƒ¢ãƒ‡ãƒ«ãŒäº‹å‰ã«æ±ºã‚ã‚‰ã‚ŒãŸå“è³ªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ãªã„å ´åˆã«å‚™ãˆã¦ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã™ã‚‹`FailStep`ã‚‚è¿½åŠ ã§æŒ‡å®šã—ã¾ã™ï¼š

```
register_step = ModelStep(
    name='RegisterTrainedModel',
    step_args=model_registry_args
)

metrics_fail_step = FailStep(
    name="RMSEFail",
    error_message=Join(on=" ", values=["Execution failed due to RMSE >", rmse_threshold]),
)

```

æ¬¡ã«ã€`ConditionStep`ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ç™»éŒ²ã‚¹ãƒ†ãƒƒãƒ—ã¾ãŸã¯å¤±æ•—ã‚¹ãƒ†ãƒƒãƒ—ã®ã©ã¡ã‚‰ã‚’å–ã‚‹ã¹ãã‹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚ã“ã®å ´åˆã€æœ€è‰¯ã®ãƒ¢ãƒ‡ãƒ«ã¯ãã®RMSEã‚¹ã‚³ã‚¢ãŒé–¾å€¤ã‚ˆã‚Šä½ã„å ´åˆã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚

```
# Condition step for evaluating model quality and branching execution
cond_lte = ConditionLessThanOrEqualTo(
    left=JsonGet(
        step_name=evaluation_step.name,
        property_file=evaluation_report,
        json_path='regression_metrics.rmse.value',
    ),
    right=rmse_threshold,
)
condition_step = ConditionStep(
    name='CheckEvaluation',
    conditions=[cond_lte],
    if_steps=[register_step],
    else_steps=[metrics_fail_step],
)
```

æœ€å¾Œã«ã€å®šç¾©ã•ã‚ŒãŸã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ï¼š

```
pipeline_name = 'synthetic-housing-training-sm-pipeline-ray'
step_list = [
             feature_store_ingestion_step,
             preprocess_dataset_step,
             tuning_step,
             evaluation_step,
             condition_step
            ]

training_pipeline = Pipeline(
    name=pipeline_name,
    parameters=[
        processing_instance_count,
        feature_group_name,
        train_size,
        val_size,
        test_size,
        bucket_prefix,
        rmse_threshold
    ],
    steps=step_list
)

# Note: If an existing pipeline has the same name it will be overwritten.
training_pipeline.upsert(role_arn=role_arn)

```

ä¸Šè¨˜ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯SageMaker Studioã§ç›´æ¥è¦–è¦šåŒ–ãŠã‚ˆã³å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã¯ã€`execution = training_pipeline.start()`ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§å®Ÿè¡Œã§ãã¾ã™ã€‚ä»¥ä¸‹ã®å›³ã¯ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ãƒ•ãƒ­ãƒ¼ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

![SageMaker Pipeline DAG](https://d2908q01vomqb2.cloudfront.net/f1f836cb4ea6efb2a0b1b99f41ad8b103eff4b59/2023/09/11/DBBLOG_15189_image1.jpng_-1024x900.png)

ã•ã‚‰ã«ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ç³»çµ±ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
from sagemaker.lineage.visualizer import LineageTableVisualizer

viz = LineageTableVisualizer(sagemaker.session.Session())
for execution_step in reversed(execution.list_steps()):
    print(execution_step)
    display(viz.show(pipeline_execution_step=execution_step))
    time.sleep(5)

```

## ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã‚’é€šã˜ã¦æœ€è‰¯ã®ãƒ¢ãƒ‡ãƒ«ãŒSageMaker Model Registryã«ç™»éŒ²ã•ã‚ŒãŸå¾Œã€SageMakerã®å®Œå…¨ã«ç®¡ç†ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚SageMakerã«ã¯ã€ã•ã¾ã–ã¾ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ãƒ‹ãƒ¼ã‚ºã‚’æº€ãŸã™ä»–ã®ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚ã‚ã‚Šã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«é©ã—ãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã™ã‚‹éš›ã«[æ¨è«–ã®ãŸã‚ã®ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤](https://docs.aws.amazon.com/sagemaker/latest/dg/deploy-model.html)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã¾ãšã€SageMaker Model Registryã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—ã—ã¾ã—ã‚‡ã†ï¼š

```
xgb_regressor_model = ModelPackage(
    role_arn,
    model_package_arn=model_package_arn,
    name=model_name
)
```

ãƒ¢ãƒ‡ãƒ«ã®ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯`PendingApproval`ã§ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’`Approved`ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

```
sagemaker_client.update_model_package(
    ModelPackageArn=xgb_regressor_model.model_package_arn,
    ModelApprovalStatus='Approved'
)

xgb_regressor_model.deploy(
    initial_instance_count=1,
    instance_type='ml.m5.xlarge',
    endpoint_name=endpoint_name
)

```

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

å®Ÿé¨“ãŒçµ‚ã‚ã£ãŸã‚‰ã€ä¸è¦ãªæ–™é‡‘ã‚’é¿ã‘ã‚‹ãŸã‚ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ã«ã¯ã€[DeleteEndpoint](https://docs.aws.amazon.com/sagemaker/latest/APIReference/API%5FDeleteEndpoint.html)ã€[DeleteModelPackageGroup](https://docs.aws.amazon.com/sagemaker/latest/APIReference/API%5FDeleteModelPackageGroup.html)ã€[DeletePipeline](https://docs.aws.amazon.com/sagemaker/latest/APIReference/API%5FDeletePipeline.html)ã€[DeleteFeatureGroup](https://docs.aws.amazon.com/sagemaker/latest/APIReference/API%5FDeleteFeatureGroup.html)ã®APIã‚’ãã‚Œãã‚Œå‘¼ã³å‡ºã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ãƒ¢ãƒ‡ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã€ã™ã¹ã¦ã®SageMaker Studioãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã—ã¾ã™ã€‚

## çµè«–

ã“ã®ãƒã‚¹ãƒˆã§ã¯ã€Rayãƒ™ãƒ¼ã‚¹ã®MLãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ãŸã‚ã«SageMaker Pipelinesã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã®èª¬æ˜ã‚’è¡Œã„ã¾ã—ãŸã€‚ã¾ãŸã€SageMaker PipelinesãŒã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®MLãƒ„ãƒ¼ãƒ«ã¨çµ±åˆã™ã‚‹èƒ½åŠ›ã‚‚ç¤ºã—ã¾ã—ãŸã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å„ªä½æ€§ã¨é‹ç”¨åŠ¹ç‡ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§å®‰å…¨ãªæ–¹æ³•ã§Rayãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã•ã¾ã–ã¾ãªAWSã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚ä»Šåº¦ã¯ã‚ãªãŸã®ç•ªã§ã™ã€‚ã“ã‚Œã‚‰ã®å¼·åŠ›ãªæ©Ÿèƒ½ã‚’æ¢ç´¢ã—ã€Amazon SageMaker Pipelinesã¨Rayã‚’ä½¿ç”¨ã—ã¦æ©Ÿæ¢°å­¦ç¿’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€é©åŒ–ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ä»Šã™ãè¡Œå‹•ã—ã¦ã€MLãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å¯èƒ½æ€§ã‚’æœ€å¤§é™ã«å¼•ãå‡ºã—ã¾ã—ã‚‡ã†ï¼

---

### è‘—è€…ã«ã¤ã„ã¦

**![](https://d2908q01vomqb2.cloudfront.net/f1f836cb4ea6efb2a0b1b99f41ad8b103eff4b59/2023/09/12/raju-rangan-ml-blog-profile-edit.png)Raju Rangan**ã¯Amazon Web Servicesï¼ˆAWSï¼‰ã®ã‚·ãƒ‹ã‚¢ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã§ã™ã€‚å½¼ã¯æ”¿åºœæ”¯æ´å›£ä½“ã¨å”åŠ›ã—ã€AWSã‚’ä½¿ç”¨ã—ã¦AI/MLã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ã®ã‚’æ”¯æ´ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã„ã˜ã£ã¦ã„ãªã„ã¨ãã¯ã€å®¶æ—ã¨éã”ã—ãŸã‚Šã€å‹äººã¨ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã®æ´»æ°—ã‚ã‚‹ã‚²ãƒ¼ãƒ ã§ã‚·ãƒ£ãƒˆãƒ«ã‚’æ‰“ã¡åˆã£ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚

**![](https://d2908q01vomqb2.cloudfront.net/f1f836cb4ea6efb2a0b1b99f41ad8b103eff4b59/2021/07/16/Sherry-Ding.jpg)Sherry Ding**ã¯Amazon Web Servicesï¼ˆAWSï¼‰ã®ã‚·ãƒ‹ã‚¢AI/MLã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã§ã™ã€‚å½¼å¥³ã¯ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã®åšå£«å·ã‚’æŒã¡ã€æ©Ÿæ¢°å­¦ç¿’ã«é–¢ã™ã‚‹è±Šå¯ŒãªçµŒé¨“ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ä¸»ã«å…¬å…±éƒ¨é–€ã®é¡§å®¢ã¨ã•ã¾ã–ã¾ãªAI/MLé–¢é€£ã®ãƒ“ã‚¸ãƒã‚¹èª²é¡Œã«å–ã‚Šçµ„ã¿ã€AWSã‚¯ãƒ©ã‚¦ãƒ‰ã§ã®æ©Ÿæ¢°å­¦ç¿’ã®æ—…ã‚’åŠ é€Ÿã™ã‚‹ã®ã‚’æ”¯æ´ã—ã¦ã„ã¾ã™ã€‚é¡§å®¢ã‚’æ”¯æ´ã—ã¦ã„ãªã„ã¨ãã¯ã€ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢æ´»å‹•ã‚’æ¥½ã—ã‚“ã§ã„ã¾ã™ã€‚