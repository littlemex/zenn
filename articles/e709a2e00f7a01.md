---
title: "00045.SageMaker é–‹ç™ºç’°å¢ƒã‚’æ•´ãˆã‚‹"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS"]
published: true
---

# Situation

ã„ã¡ã„ã¡ AWS Console ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‹ã‚‰ SageMaker ãƒšãƒ¼ã‚¸çµŒç”±ã§ SageMaker ã® Notebook ãƒšãƒ¼ã‚¸ã‚’å‡ºã™ã®ãŒã‚ã‚“ã©ãã•ãã¦ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã£ã½ã„ä½“é¨“ãŒå¾—ã¥ã‚‰ã„ã€‚ã€‚ãã—ã¦ã€Notebook ã§ã¯ãªãã¦ VS Code ã§ã‚«ã‚¤ãƒãƒ„ã‚·ã‚¿ã‚¤ã€‚

# Goal

1. Notebook ãƒšãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ãŸãŸã„ãŸã‚‰é–‹ãã‚ˆã†ã«ã™ã‚‹
2. ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ VS Code ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ç™ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ 

# Prerequisites

- IAM role, ãƒ­ãƒ¼ã‚«ãƒ«ã® credentials è¨­å®šã¯é©å½“ã«ã‚°ã‚°ã£ã¦é ‘å¼µã£ã¦è¨­å®šã—ã¦ã„ã‚‹çŠ¶æ…‹
- å¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ã¯ãªã‚“ã‹é ‘å¼µã£ã¦è¨­å®šã—ã¦ã„ã‚‹çŠ¶æ…‹

# Step1: Notebook ã‚’ã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ã§é–‹ãã‚ˆã†ã«ã™ã‚‹

çµè«–ï¼šã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ã§é–‹ãã¾ã§ã¯ç’°å¢ƒä¾å­˜ã‚ã‚‹ã®ã§æ–­å¿µãƒ»ãƒ»ã€‚URLè¡¨ç¤ºã¾ã§å®Ÿæ–½

[ã“ã“ã¾ã§ã®æˆæœ](https://gist.github.com/littlemex/5c7be4b39b4d3238206a297022a70ac8)

# Step2: Notebook ä¸Šã§ [Code Server](https://aws.amazon.com/jp/blogs/machine-learning/host-code-server-on-amazon-sagemaker/) ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

æ‰‹å‹•ã§æ¯å› Code Server è¨­å®šã™ã‚‹ã®ãŒã ã‚‹ã„ã®ã§ Step1 ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«è¨­å®šã‚’å…¥ã‚Œè¾¼ã‚€ã€‚

[ã“ã“ã¾ã§ã®æˆæœ](https://gist.github.com/littlemex/76a3af056d2c85abd1c647fe24651029)

# Demo

## Case1: æ—¢ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹å ´åˆ

```bash
bash -x tmp.sh 
+ NOTEBOOK_INSTANCE_NAME=id00045V03
+ INSTANCE_TYPE=ml.g5.xlarge
+ INSTANCE_VOLUME=500
+ AWS_REGION=us-east-1
+ ROLE_ARN=arn:aws:iam::XXXXX:role/service-role/SageMaker-MLOpsEngineer
+ check_instance_status ''
++ aws sagemaker describe-notebook-instance --notebook-instance-name id00045V03 --output text --query NotebookInstanceStatus --region us-east-1
+ local status=InService
+ '[' -z InService ']'
+ '[' InService '!=' InService ']'
+ return 0
+ '[' 0 -eq 0 ']'
+ create_presigned_url
++ aws sagemaker create-presigned-notebook-instance-url --notebook-instance-name id00045V03 --query AuthorizedUrl --output text --session-expiration-duration-in-seconds 3600
+ PRESIGNED_URL='https://id00045v03.notebook.us-east-1.sagemaker.aws?authToken=eyJhbGciOiJIUzI1NiJ9.eyJ...
+ echo URL:
URL:
+ echo 'https://id00045v03.notebook.us-east-1.sagemaker.aws?authToken=eyJ...
+ tee .presignedURL
```

## Case2: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒãªã„å ´åˆ

--create ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹ã€‚

```bash
bash -x tmp.sh --create

bash -x tmp.sh --create
+ NOTEBOOK_INSTANCE_NAME=id00045V03
+ INSTANCE_TYPE=ml.g5.xlarge
+ INSTANCE_VOLUME=500
+ AWS_REGION=us-east-1
+ ROLE_ARN=arn:aws:iam::XXXXX:role/service-role/SageMaker-MLOpsEngineer
+ check_instance_status --create
++ aws sagemaker describe-notebook-instance --notebook-instance-name id00045V03 --output text --query NotebookInstanceStatus --region us-east-1
+ local status=
+ '[' -z '' ']'
+ '[' --create == --create ']'
+ create_instance
+ curl -LO https://github.com/aws-samples/amazon-sagemaker-codeserver/releases/download/v0.2.0/amazon-sagemaker-codeserver-0.2.0.tar.gz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100  2958  100  2958    0     0   2452      0  0:00:01  0:00:01 --:--:--     0
+ tar -xvzf amazon-sagemaker-codeserver-0.2.0.tar.gz
amazon-sagemaker-codeserver/install-scripts/notebook-instances/
amazon-sagemaker-codeserver/install-scripts/notebook-instances/install-codeserver.sh
amazon-sagemaker-codeserver/install-scripts/notebook-instances/uninstall-codeserver.sh
amazon-sagemaker-codeserver/install-scripts/notebook-instances/setup-codeserver.sh
amazon-sagemaker-codeserver/install-scripts/studio/
amazon-sagemaker-codeserver/install-scripts/studio/install-codeserver.sh
amazon-sagemaker-codeserver/install-scripts/studio/uninstall-codeserver.sh
+ cd amazon-sagemaker-codeserver/install-scripts/notebook-instances

### lifecycle-config ã¯ã™ã§ã«ä½œã£ã¦ã„ãŸã®ã§ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã‚‹

+ aws sagemaker create-notebook-instance --notebook-instance-name id00045V03 --instance-type ml.g5.xlarge --role-arn arn:aws:iam::XXXXX:role/service-role/SageMaker-MLOpsEngineer --direct-internet-access Enabled --volume-size-in-gb 5 --root-access Enabled --platform-identifier notebook-al2-v2 --region us-east-1 --lifecycle-config-name install-codeserver
{
    "NotebookInstanceArn": "arn:aws:sagemaker:us-east-1:XXXXX:notebook-instance/id00045V03"
}
+ return 0
+ wait_for_instance_ready
+ local max_attempts=60
+ local attempt=0
+ '[' 0 -lt 60 ']'
++ aws sagemaker describe-notebook-instance --notebook-instance-name id00045V03 --output text --query NotebookInstanceStatus --region us-east-1
+ local status=Pending
+ '[' Pending == InService ']'
+ echo 'Notebook Instance '\''id00045V03'\'' ã¯ã¾ã æº–å‚™ä¸­ã§ã™ã€‚(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: Pending) 10ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™ã€‚'
Notebook Instance 'id00045V03' ã¯ã¾ã æº–å‚™ä¸­ã§ã™ã€‚(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: Pending) 10ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™ã€‚
+ sleep 10
+ (( attempt++ ))
+ '[' 1 -lt 60 ']'
++ aws sagemaker describe-notebook-instance --notebook-instance-name id00045V03 --output text --query NotebookInstanceStatus --region us-east-1
+ local status=Pending
+ '[' Pending == InService ']'
+ echo 'Notebook Instance '\''id00045V03'\'' ã¯ã¾ã æº–å‚™ä¸­ã§ã™ã€‚(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: Pending) 10ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™ã€‚'
Notebook Instance 'id00045V03' ã¯ã¾ã æº–å‚™ä¸­ã§ã™ã€‚(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: Pending) 10ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™ã€‚
+ sleep 10
+ (( attempt++ ))

...

+ '[' 27 -lt 60 ']'
++ aws sagemaker describe-notebook-instance --notebook-instance-name id00045V03 --output text --query NotebookInstanceStatus --region us-east-1
+ local status=InService
+ '[' InService == InService ']'
+ return 0
+ return 0
+ '[' 0 -eq 0 ']'
+ create_presigned_url
++ aws sagemaker create-presigned-notebook-instance-url --notebook-instance-name id00045V03 --query AuthorizedUrl --output text --session-expiration-duration-in-seconds 3600
+ PRESIGNED_URL='https://id00045v03.notebook.us-east-1.sagemaker.aws?authToken=eyJhbG....
+ echo URL:
URL:
+ tee .presignedURL
```

ã„ã„æ„Ÿã˜ã§ Presigned URL ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã„ã¦ Code Server ã‹ã‚‰é–‹ç™ºãŒã§ããã†ã€‚

![](/images/e709a2e00f7a01.notebook.png)

![](/images/e709a2e00f7a01.code-server.png)

# Conclusion

- [ ] (æ–­å¿µ)Notebook ãƒšãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ãŸãŸã„ãŸã‚‰é–‹ãã‚ˆã†ã«ã™ã‚‹
    - [x] Notebook Presigned URL ã‚’æ‰•ã„ã ã™
- [x] ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ VS Code ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ç™ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹